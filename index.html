<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>随手记 Cloud Pro (资产管理版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        teal: { 50: '#f0fdfa', 100: '#ccfbf1', 400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488', 800: '#115e59', 900: '#134e4a' },
                        stone: { 50: '#fafaf9', 100: '#f5f5f4', 200: '#e7e5e4', 300: '#d6d3d1', 800: '#292524', 900: '#1c1917' },
                    },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.05)',
                        'card': '0 2px 20px rgba(0, 0, 0, 0.02), 0 10px 40px rgba(0, 0, 0, 0.04)',
                    },
                    animation: { 'fade-in': 'fadeIn 0.4s ease-out forwards' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }

        // --- SUPABASE 配置 ---
        const SUPABASE_URL = 'https://dokkfbtuusvmofqlkxal.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRva2tmYnR1dXN2bW9mcWxreGFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwMTczNzgsImV4cCI6MjA4NTU5MzM3OH0.jFg3q_clPEIRw6Wtjxgvk2s-bA1df2AM0MRuNMGYfTg';
        
        let supabaseClient = null;
        function initSupabase() { if (window.supabase) supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); }
    </script>
    <style>
        body { background-color: #f5f5f4; color: #292524; overflow: hidden; }
        ::-webkit-scrollbar { width: 5px; height: 5px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 3px; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.6); }
        .modern-input { background: #f5f5f4; border: 1px solid transparent; transition: all 0.2s; } .modern-input:focus { background: white; border-color: #14b8a6; outline: none; box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1); }
        .nav-item.active { background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%); color: white; box-shadow: 0 4px 15px rgba(20, 184, 166, 0.3); }
        .asset-card-bg { background: white; border: 1px solid #f5f5f4; }
        .asset-card-bg.liability .balance { color: #ef4444; }
        .hidden-view { display: none !important; }
    </style>
</head>
<body class="font-sans selection:bg-teal-100 selection:text-teal-900">

    <!-- LOGIN -->
    <div id="auth-view" class="fixed inset-0 z-50 flex items-center justify-center bg-[#f0f2f5] hidden-view">
        <div class="glass-panel w-full max-w-md p-8 rounded-3xl shadow-xl animate-fade-in relative mx-4">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-br from-teal-400 to-teal-600 rounded-2xl flex items-center justify-center text-white text-2xl shadow-lg mx-auto mb-4"><i class="fa-solid fa-cloud"></i></div>
                <h2 class="text-2xl font-bold text-stone-800">随手记 Cloud</h2>
                <p class="text-stone-500 text-sm mt-1">桌面云端同步版</p>
            </div>
            <form id="login-form" class="space-y-4">
                <input type="email" id="login-email" class="modern-input w-full px-4 py-3 rounded-xl font-medium" placeholder="邮箱">
                <input type="password" id="login-pass" class="modern-input w-full px-4 py-3 rounded-xl font-medium" placeholder="密码">
                <button type="submit" id="login-btn" class="w-full bg-stone-800 hover:bg-black text-white py-3.5 rounded-xl font-bold transition shadow-lg">登录 / 注册</button>
            </form>
            <div class="relative my-6"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div><div class="relative flex justify-center text-sm"><span class="px-2 bg-white/50 text-gray-500">或</span></div></div>
            <button onclick="Auth.loginAsGuest()" class="w-full bg-white border border-stone-200 text-stone-600 hover:bg-stone-50 py-3 rounded-xl font-bold transition">游客试用 (离线)</button>
            <p id="login-msg" class="text-center text-xs text-red-500 mt-4"></p>
        </div>
    </div>

    <!-- APP -->
    <div id="app-view" class="flex h-screen hidden-view animate-fade-in opacity-0">
        <!-- SIDEBAR -->
        <aside class="w-64 flex-none bg-white border-r border-stone-100 flex flex-col z-20">
            <div class="h-20 flex items-center px-8"><div class="w-8 h-8 bg-gradient-to-br from-teal-400 to-teal-600 rounded-lg flex items-center justify-center text-white shadow-lg mr-3"><i class="fa-solid fa-cloud"></i></div><span class="font-bold text-xl text-stone-800">Cloud Pro</span></div>
            <nav class="flex-1 px-4 py-6 space-y-2">
                <button onclick="Router.navigate('dashboard')" class="nav-item active w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium" data-tab="dashboard"><i class="fa-solid fa-layer-group w-5 text-center"></i> 概览</button>
                <button onclick="Router.navigate('assets')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-stone-500 text-sm font-medium" data-tab="assets"><i class="fa-solid fa-wallet w-5 text-center"></i> 我的资产</button>
                <button onclick="Router.navigate('analysis')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-stone-500 text-sm font-medium" data-tab="analysis"><i class="fa-solid fa-chart-pie w-5 text-center"></i> 收支分析</button>
                <button onclick="Router.navigate('transactions')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-stone-500 text-sm font-medium" data-tab="transactions"><i class="fa-solid fa-list-ul w-5 text-center"></i> 账单明细</button>
            </nav>
            <div class="p-4 border-t border-stone-100"><div class="flex items-center gap-3 px-4 py-2 rounded-xl bg-stone-50 mb-2"><div class="w-8 h-8 rounded-full bg-teal-100 text-teal-600 flex items-center justify-center font-bold text-xs" id="user-avatar">U</div><div class="flex-1 min-w-0"><p class="text-sm font-bold text-stone-800 truncate" id="user-email">User</p><p class="text-[10px] text-stone-400" id="user-status">Online</p></div></div><button onclick="Auth.logout()" class="w-full text-xs text-stone-400 hover:text-red-500 py-1">退出</button></div>
        </aside>

        <!-- MAIN -->
        <main class="flex-1 flex flex-col relative overflow-hidden bg-[#F8FAFC]">
            <header class="h-20 flex-none px-8 flex items-center justify-between z-10">
                <div><h2 id="page-title" class="text-2xl font-bold text-stone-800">概览</h2><p class="text-xs text-stone-400 mt-1" id="current-date">...</p></div>
                <div class="flex gap-2">
                    <button onclick="DataService.init()" class="w-10 h-10 bg-white rounded-full border border-stone-200 flex items-center justify-center text-stone-500 hover:text-teal-600 shadow-sm" title="刷新"><i class="fa-solid fa-rotate"></i></button>
                </div>
            </header>
            <div id="main-view" class="flex-1 overflow-y-auto px-8 pb-8 pt-2 relative"></div>
        </main>
    </div>

    <!-- MODAL: ADD ASSET -->
    <div id="asset-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden-view">
        <div class="bg-white w-96 rounded-2xl p-6 shadow-2xl animate-fade-in">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-stone-800">添加新账户</h3><button onclick="document.getElementById('asset-modal').classList.add('hidden-view')" class="text-stone-400 hover:text-stone-600"><i class="fa-solid fa-xmark"></i></button></div>
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-stone-500 ml-1">账户名称</label><input id="new-asset-name" class="modern-input w-full px-4 py-3 rounded-xl text-sm mt-1" placeholder="如: 招商银行, 支付宝"></div>
                <div><label class="text-xs font-bold text-stone-500 ml-1">当前余额</label><input id="new-asset-bal" type="number" class="modern-input w-full px-4 py-3 rounded-xl text-sm mt-1" placeholder="¥ 0.00"></div>
                <div><label class="text-xs font-bold text-stone-500 ml-1">账户类型</label>
                <div class="flex gap-2 mt-1">
                    <button onclick="Handlers.setNewAssetType('asset')" id="btn-na-asset" class="flex-1 py-2 rounded-lg text-xs font-bold bg-teal-50 text-teal-700 border border-teal-200 transition">资产 (储蓄/现金)</button>
                    <button onclick="Handlers.setNewAssetType('liability')" id="btn-na-liab" class="flex-1 py-2 rounded-lg text-xs font-bold bg-white text-stone-500 border border-stone-200 transition">负债 (信用卡/借款)</button>
                </div></div>
            </div>
            <button onclick="Handlers.submitAsset()" class="w-full mt-6 py-3 rounded-xl text-sm font-bold bg-stone-800 text-white shadow-lg hover:bg-black transition">保存账户</button>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-8 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur border border-stone-200 px-6 py-3 rounded-full shadow-lg text-sm font-bold text-stone-700 flex items-center gap-2 transition-all opacity-0 pointer-events-none z-[60] -translate-y-10"><i class="fa-solid fa-check-circle text-teal-500"></i><span id="toast-msg">OK</span></div>

    <script>
        // --- 核心逻辑 ---
        const State = {
            user: null, isGuest: false,
            transactions: [], assets: [],
            categories: {
                expense: [ {id:'food',name:'餐饮',icon:'fa-utensils'}, {id:'shop',name:'购物',icon:'fa-bag-shopping'}, {id:'traffic',name:'交通',icon:'fa-bus'}, {id:'home',name:'居住',icon:'fa-house'}, {id:'ent',name:'娱乐',icon:'fa-film'}, {id:'med',name:'医疗',icon:'fa-notes-medical'}, {id:'other',name:'其他',icon:'fa-circle-notch'} ],
                income: [ {id:'salary',name:'工资',icon:'fa-money-bill'}, {id:'invest',name:'理财',icon:'fa-chart-line'}, {id:'other',name:'其他',icon:'fa-plus'} ]
            },
            input: { type: 'expense', newAssetType: 'asset' }
        };

        const Auth = {
            async init() {
                initSupabase();
                const guest = localStorage.getItem('guest') === 'true';
                if(guest) return this.loginAsGuest();
                
                if(supabaseClient) {
                    const {data} = await supabaseClient.auth.getSession();
                    if(data.session) this.setUser(data.session.user, false);
                    else this.showLogin();
                } else this.showLogin();
                
                document.getElementById('login-form').addEventListener('submit', this.handleLogin);
            },
            loginAsGuest() { localStorage.setItem('guest','true'); this.setUser({id:'guest',email:'Guest'}, true); },
            async handleLogin(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value, pass = document.getElementById('login-pass').value;
                const btn = document.getElementById('login-btn'), msg = document.getElementById('login-msg');
                btn.disabled = true; btn.innerText = "处理中..."; msg.innerText = "";
                
                let {data, error} = await supabaseClient.auth.signInWithPassword({email, password: pass});
                if(error) {
                    const res = await supabaseClient.auth.signUp({email, password: pass});
                    if(res.error) { msg.innerText = "错误: " + res.error.message; btn.disabled=false; btn.innerText="登录/注册"; return; }
                    data = res.data; Helpers.toast("注册并登录成功");
                }
                Auth.setUser(data.user, false);
            },
            setUser(u, g) {
                State.user = u; State.isGuest = g;
                document.getElementById('auth-view').classList.add('hidden-view');
                document.getElementById('app-view').classList.remove('hidden-view');
                setTimeout(()=>document.getElementById('app-view').classList.remove('opacity-0'), 50);
                document.getElementById('user-email').innerText = u.email.split('@')[0];
                document.getElementById('user-avatar').innerText = u.email[0].toUpperCase();
                document.getElementById('user-status').innerText = g ? '离线模式' : '已连接云端';
                DataService.init();
            },
            async logout() { if(confirm('退出?')) { if(State.isGuest) localStorage.removeItem('guest'); else await supabaseClient.auth.signOut(); location.reload(); } },
            showLogin() { document.getElementById('auth-view').classList.remove('hidden-view'); }
        };

        const DataService = {
            async init() {
                if(!State.user) return;
                // Fetch Assets & Txs
                if(State.isGuest) {
                    State.assets = JSON.parse(localStorage.getItem('assets')||'[]');
                    State.transactions = JSON.parse(localStorage.getItem('txs')||'[]');
                } else {
                    const {data: a} = await supabaseClient.from('assets').select('*').order('created_at');
                    State.assets = a || [];
                    const {data: t} = await supabaseClient.from('transactions').select('*').order('date', {ascending:false});
                    State.transactions = t || [];
                }
                // 如果没有账户，创建一个默认的
                if(State.assets.length === 0) await this.addAsset('现金钱包', 0, 'asset');
                else Router.navigate(Router.currentTab || 'dashboard');
            },
            async addAsset(name, bal, type) {
                const item = { user_id: State.user.id, name, balance: parseFloat(bal), type, created_at: new Date().toISOString() };
                if(State.isGuest) { item.id = Date.now(); State.assets.push(item); localStorage.setItem('assets', JSON.stringify(State.assets)); }
                else {
                    // 不需要传ID，由数据库自动生成
                    const {error} = await supabaseClient.from('assets').insert([item]);
                    if(error) return alert(error.message);
                    await this.init(); // Refresh
                }
            },
            async addTx(payload) {
                const tx = { user_id: State.user.id, ...payload };
                // 1. Save Tx
                if(State.isGuest) { tx.id = Date.now(); State.transactions.unshift(tx); localStorage.setItem('txs', JSON.stringify(State.transactions)); }
                else { 
                    // Remove id if present to let DB auto-gen
                    delete tx.id;
                    const {error} = await supabaseClient.from('transactions').insert([tx]); 
                    if(error) return alert("记账失败: "+error.message); 
                }
                
                // 2. Update Asset Balance
                const asset = State.assets.find(a => a.id == payload.asset_id);
                if(asset) {
                    let newBal = parseFloat(asset.balance);
                    if(payload.type === 'expense') newBal -= payload.amount; else newBal += payload.amount;
                    
                    if(State.isGuest) { asset.balance = newBal; localStorage.setItem('assets', JSON.stringify(State.assets)); }
                    else { await supabaseClient.from('assets').update({balance: newBal}).eq('id', asset.id); }
                }
                
                Helpers.toast("记账成功");
                this.init(); // Reload all
                return true;
            },
            async delTx(id) {
                if(!confirm('删除记录并回滚余额?')) return;
                const tx = State.transactions.find(t => t.id == id);
                if(!tx) return;

                // Revert Balance
                const asset = State.assets.find(a => a.id == tx.asset_id);
                if(asset) {
                    let newBal = parseFloat(asset.balance);
                    // Reverse logic to undo
                    if(tx.type === 'expense') newBal += tx.amount; else newBal -= tx.amount;
                    
                    if(State.isGuest) { asset.balance = newBal; localStorage.setItem('assets', JSON.stringify(State.assets)); }
                    else { await supabaseClient.from('assets').update({balance: newBal}).eq('id', asset.id); }
                }

                // Delete Tx
                if(State.isGuest) { State.transactions = State.transactions.filter(t => t.id !== id); localStorage.setItem('txs', JSON.stringify(State.transactions)); }
                else { await supabaseClient.from('transactions').delete().eq('id', id); }
                
                Helpers.toast("已删除");
                this.init();
            }
        };

        const Router = {
            currentTab: 'dashboard',
            navigate(tab) {
                this.currentTab = tab;
                document.querySelectorAll('.nav-item').forEach(el => {
                    el.classList.toggle('active', el.dataset.tab === tab);
                    el.classList.toggle('text-stone-500', el.dataset.tab !== tab);
                    el.classList.toggle('text-white', el.dataset.tab === tab);
                });
                document.getElementById('page-title').innerText = {dashboard:'概览', assets:'我的资产', analysis:'收支分析', transactions:'账单明细'}[tab];
                document.getElementById('current-date').innerText = new Date().toLocaleDateString('zh-CN');
                const view = document.getElementById('main-view');
                if(Render[tab]) Render[tab](view);
            }
        };

        const Render = {
            dashboard(el) {
                const stats = Helpers.calcStats();
                const recent = State.transactions.slice(0, 5);
                // Asset Options for Select
                const assetOptions = State.assets.map(a => `<option value="${a.id}">${a.name} (¥${a.balance})</option>`).join('');
                
                el.innerHTML = `
                    <div class="grid grid-cols-12 gap-6 pb-10 animate-fade-in">
                        <!-- Stats Cards -->
                        <div class="col-span-4 bg-white rounded-3xl p-6 shadow-card border border-stone-50"><p class="text-xs text-stone-400 font-bold mb-1">本月支出</p><h3 class="text-2xl font-bold text-stone-800">¥${stats.exp}</h3></div>
                        <div class="col-span-4 bg-white rounded-3xl p-6 shadow-card border border-stone-50"><p class="text-xs text-stone-400 font-bold mb-1">本月收入</p><h3 class="text-2xl font-bold text-teal-600">¥${stats.inc}</h3></div>
                        <div class="col-span-4 bg-stone-800 rounded-3xl p-6 shadow-card text-white"><p class="text-xs text-stone-400 font-bold mb-1">净资产</p><h3 class="text-2xl font-bold">¥${stats.net}</h3></div>

                        <!-- 记账卡片 -->
                        <div class="col-span-5 bg-white rounded-3xl p-6 shadow-card border border-stone-50 h-[420px] flex flex-col relative overflow-hidden">
                            <h3 class="font-bold text-stone-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-pen-nib text-teal-500"></i> 快速记账</h3>
                            
                            <div class="flex bg-stone-100 p-1 rounded-xl mb-4">
                                <button onclick="Handlers.setType('expense')" id="btn-expense" class="flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow-sm text-stone-800 transition">支出</button>
                                <button onclick="Handlers.setType('income')" id="btn-income" class="flex-1 py-2 rounded-lg text-sm font-bold text-stone-500 transition">收入</button>
                            </div>
                            
                            <div class="space-y-4 flex-1">
                                <div><label class="text-[10px] text-stone-400 font-bold ml-1">金额</label>
                                <div class="relative"><span class="absolute left-3 top-2.5 text-stone-400 font-bold">¥</span><input type="number" id="in-amount" class="modern-input w-full pl-8 pr-4 py-2.5 rounded-xl font-bold text-stone-800 text-lg" placeholder="0.00"></div></div>
                                
                                <div class="grid grid-cols-2 gap-3">
                                    <div><label class="text-[10px] text-stone-400 font-bold ml-1">分类</label>
                                    <select id="in-cat" class="modern-input w-full px-3 py-2.5 rounded-xl text-sm text-stone-700 bg-white appearance-none cursor-pointer"></select></div>
                                    <div><label class="text-[10px] text-stone-400 font-bold ml-1">账户</label>
                                    <select id="in-asset" class="modern-input w-full px-3 py-2.5 rounded-xl text-sm text-stone-700 bg-white appearance-none cursor-pointer border-l-4 border-teal-500">${assetOptions}</select></div>
                                </div>

                                <div><label class="text-[10px] text-stone-400 font-bold ml-1">备注</label>
                                <input type="text" id="in-note" class="modern-input w-full px-4 py-2.5 rounded-xl text-sm" placeholder="备注..."></div>
                            </div>
                            <button onclick="Handlers.submit()" class="w-full bg-stone-800 hover:bg-black text-white py-3 rounded-xl font-bold mt-4 shadow-lg active:scale-95 transition">确认记账</button>
                        </div>

                        <!-- 近期列表 -->
                        <div class="col-span-7 bg-white rounded-3xl p-6 shadow-card border border-stone-50 h-[420px] flex flex-col">
                            <h3 class="font-bold text-stone-800 mb-4">近期账单</h3>
                            <div class="flex-1 overflow-auto"><table class="w-full text-left"><tbody class="text-sm">
                                ${recent.map(t => {
                                    const cat = Helpers.getCat(t.type, t.category);
                                    const asset = State.assets.find(a=>a.id==t.asset_id) || {name:'-'};
                                    return `<tr class="border-b border-stone-50 last:border-0 hover:bg-stone-50">
                                        <td class="py-3 pl-2"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-lg flex items-center justify-center text-xs bg-stone-100 text-stone-500"><i class="fa-solid ${cat.icon}"></i></div><div><div class="font-bold text-stone-700">${cat.name}</div><div class="text-[10px] text-stone-400">${asset.name} · ${t.note||'-'}</div></div></div></td>
                                        <td class="text-right font-bold pr-2 ${t.type==='expense'?'text-stone-800':'text-teal-600'}">${t.type==='expense'?'-':'+'} ${t.amount}</td>
                                    </tr>`;
                                }).join('')}
                            </tbody></table>
                            ${recent.length===0?'<div class="text-center text-stone-300 mt-10 text-sm">暂无数据</div>':''}</div>
                        </div>
                    </div>`;
                Handlers.updateCatOptions();
            },
            assets(el) {
                let cards = State.assets.map(a => {
                    let icon = Helpers.getAssetIcon(a.name);
                    return `<div class="col-span-4 rounded-3xl p-6 shadow-sm relative overflow-hidden group hover:-translate-y-1 transition duration-300 asset-card-bg ${a.type==='liability'?'liability':''}">
                        <div class="relative z-10 flex justify-between items-start mb-6">
                            <div class="w-10 h-10 rounded-full bg-stone-100 flex items-center justify-center text-stone-600 text-lg"><i class="fa-solid ${icon}"></i></div>
                            <span class="text-[10px] font-bold bg-stone-100 text-stone-500 px-2 py-1 rounded">${a.type==='asset'?'资产':'负债'}</span>
                        </div>
                        <p class="text-xs font-bold text-stone-400 mb-1">${a.name}</p>
                        <h3 class="text-2xl font-bold balance tracking-tight">¥${a.balance}</h3>
                    </div>`;
                }).join('');

                el.innerHTML = `
                    <div class="grid grid-cols-12 gap-6 animate-fade-in pb-10">
                        ${cards}
                        <!-- Add Button -->
                        <div onclick="document.getElementById('asset-modal').classList.remove('hidden-view')" class="col-span-4 rounded-3xl p-6 border-2 border-dashed border-stone-300 flex flex-col items-center justify-center text-stone-400 hover:border-teal-500 hover:text-teal-500 hover:bg-teal-50 transition cursor-pointer min-h-[180px]">
                            <i class="fa-solid fa-plus text-3xl mb-2"></i>
                            <span class="font-bold text-sm">添加账户</span>
                        </div>
                    </div>
                `;
            },
            analysis(el) { el.innerHTML = `<div class="flex items-center justify-center h-64 text-stone-400">功能与首页图表类似，此处留空...</div>`; }, 
            transactions(el) {
                el.innerHTML = `<div class="bg-white rounded-3xl shadow-card overflow-hidden animate-fade-in"><div class="p-6 border-b border-stone-100 font-bold">全部明细</div><div class="max-h-[70vh] overflow-auto"><table class="w-full text-left text-sm"><thead class="bg-stone-50 text-stone-500"><tr><th class="px-6 py-3">时间</th><th class="px-6 py-3">分类</th><th class="px-6 py-3">账户</th><th class="px-6 py-3 text-right">金额</th><th class="px-6 py-3 text-center">操作</th></tr></thead><tbody class="divide-y divide-stone-50">
                ${State.transactions.map(t=>{
                    const cat = Helpers.getCat(t.type,t.category);
                    const asset = State.assets.find(a=>a.id==t.asset_id)||{name:'-'};
                    return `<tr class="hover:bg-teal-50/20"><td class="px-6 py-4 text-stone-400">${new Date(t.date).toLocaleDateString()}</td><td class="px-6 py-4 font-bold text-stone-700">${cat.name}</td><td class="px-6 py-4 text-stone-500">${asset.name}</td><td class="px-6 py-4 text-right font-bold ${t.type==='expense'?'text-stone-800':'text-teal-600'}">${t.type==='expense'?'-':'+'}${t.amount}</td><td class="px-6 py-4 text-center"><button onclick="DataService.delTx(${t.id})" class="text-stone-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></td></tr>`;
                }).join('')}</tbody></table></div></div>`;
            }
        };

        const Handlers = {
            setType(t) { State.input.type=t; document.getElementById('btn-expense').className=t==='expense'?'flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow-sm text-stone-800 transition':'flex-1 py-2 rounded-lg text-sm font-bold text-stone-500 transition'; document.getElementById('btn-income').className=t==='income'?'flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow-sm text-teal-600 transition':'flex-1 py-2 rounded-lg text-sm font-bold text-stone-500 transition'; this.updateCatOptions(); },
            updateCatOptions() { document.getElementById('in-cat').innerHTML = State.categories[State.input.type].map(c=>`<option value="${c.id}">${c.name}</option>`).join(''); },
            async submit() {
                const amt = document.getElementById('in-amount').value;
                if(!amt) return alert("请输入金额");
                const ok = await DataService.addTx({
                    amount: parseFloat(amt), type: State.input.type, category: document.getElementById('in-cat').value,
                    asset_id: document.getElementById('in-asset').value, note: document.getElementById('in-note').value, date: new Date().toISOString()
                });
                if(ok) { document.getElementById('in-amount').value=''; document.getElementById('in-note').value=''; }
            },
            setNewAssetType(t) { State.input.newAssetType = t; const btnA = document.getElementById('btn-na-asset'), btnL = document.getElementById('btn-na-liab'); if(t==='asset') { btnA.className="flex-1 py-2 rounded-lg text-xs font-bold bg-teal-50 text-teal-700 border border-teal-200 transition"; btnL.className="flex-1 py-2 rounded-lg text-xs font-bold bg-white text-stone-500 border border-stone-200 transition"; } else { btnL.className="flex-1 py-2 rounded-lg text-xs font-bold bg-red-50 text-red-700 border border-red-200 transition"; btnA.className="flex-1 py-2 rounded-lg text-xs font-bold bg-white text-stone-500 border border-stone-200 transition"; } },
            async submitAsset() {
                const name = document.getElementById('new-asset-name').value;
                if(!name) return alert("请输入账户名称");
                await DataService.addAsset(name, document.getElementById('new-asset-bal').value||0, State.input.newAssetType);
                document.getElementById('asset-modal').classList.add('hidden-view');
                document.getElementById('new-asset-name').value = '';
                document.getElementById('new-asset-bal').value = '';
            }
        };

        const Helpers = {
            getCat(t,id) { return State.categories[t]?.find(c=>c.id==id) || {name:id,icon:'fa-question'}; },
            getAssetIcon(n) { 
                if(n.includes('支付')) return 'fa-alipay'; 
                if(n.includes('微信')) return 'fa-weixin'; 
                if(n.includes('卡')) return 'fa-credit-card'; 
                if(n.includes('现金')) return 'fa-coins';
                return 'fa-wallet'; 
            },
            calcStats() {
                const now = new Date(), curM = now.toISOString().slice(0,7);
                let exp=0, inc=0, net=0;
                State.transactions.forEach(t => { if(t.date.startsWith(curM)) { if(t.type==='income') inc+=t.amount; else exp+=t.amount; } });
                State.assets.forEach(a => { if(a.type==='asset') net+=a.balance; else net-=a.balance; });
                return { exp:exp.toFixed(2), inc:inc.toFixed(2), net:net.toFixed(2) };
            },
            toast(m) { const t=document.getElementById('toast'); document.getElementById('toast-msg').innerText=m; t.classList.remove('opacity-0', '-translate-y-10'); setTimeout(()=>t.classList.add('opacity-0', '-translate-y-10'), 2000); }
        };

        window.addEventListener('DOMContentLoaded', Auth.init.bind(Auth));
    </script>
</body>
</html>
