<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éšæ‰‹è®° Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        teal: { 50: '#f0fdfa', 100: '#ccfbf1', 400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488', 800: '#115e59', 900: '#134e4a' },
                        slate: { 850: '#1e293b' }
                    },
                    boxShadow: {
                        'soft': '0 8px 30px -6px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 20px rgba(45, 212, 191, 0.3)'
                    }
                }
            }
        }

        const SUPABASE_URL = 'https://dokkfbtuusvmofqlkxal.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRva2tmYnR1dXN2bW9mcWxreGFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwMTczNzgsImV4cCI6MjA4NTU5MzM3OH0.jFg3q_clPEIRw6Wtjxgvk2s-bA1df2AM0MRuNMGYfTg';
        
        let supabaseClient;
        function initSupabase() {
            try {
                if (typeof window.supabase !== 'undefined') {
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                }
            } catch (e) { console.error("Init Error:", e); }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #e2e8f0; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        #phone-frame { width: 100%; max-width: 414px; height: 100vh; max-height: 896px; background-color: #f8fafc; position: relative; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        @media (min-width: 450px) { #phone-frame { height: 85vh; border-radius: 40px; border: 8px solid #1e293b; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass-nav { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .toast { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; animation: fadeUp 2s ease-in-out forwards; z-index: 100; pointer-events: none; width: max-content; }
        @keyframes fadeUp { 0% { opacity: 0; transform: translate(-50%, -30px); } 15% { opacity: 1; transform: translate(-50%, -50%); } 85% { opacity: 1; transform: translate(-50%, -50%); } 100% { opacity: 0; transform: translate(-50%, -70px); } }
        .key-btn { background:white; padding:18px; font-size:20px; font-weight:500; color:#334155; transition: background 0.1s; } 
        .key-btn:active { background:#f1f5f9; }
    </style>
</head>
<body>
    <div id="phone-frame">
        <div id="toast-container"></div>

        <!-- é¡µé¢: ç™»å½•/æ³¨å†Œ (V6 æ”¹ç‰ˆ) -->
        <div id="auth-view" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-white px-8">
            <div class="mb-10 text-center">
                <div class="w-20 h-20 bg-teal-500 rounded-3xl mx-auto mb-6 flex items-center justify-center shadow-glow">
                    <i class="fa-solid fa-cloud text-4xl text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-800 mb-2">éšæ‰‹è®° Cloud</h1>
                <p class="text-gray-400 text-sm">äº‘ç«¯åŒæ­¥ Â· å®‰å…¨å­˜å‚¨</p>
            </div>

            <!-- è¡¨å•åŒºåŸŸ -->
            <div class="w-full space-y-4">
                <div class="bg-gray-50 rounded-xl px-4 py-3 flex items-center gap-3 border border-transparent focus-within:border-teal-500 transition">
                    <i class="fa-solid fa-envelope text-gray-400"></i>
                    <input type="email" id="login-email" placeholder="é‚®ç®±" class="flex-1 bg-transparent outline-none text-sm">
                </div>
                <div class="bg-gray-50 rounded-xl px-4 py-3 flex items-center gap-3 border border-transparent focus-within:border-teal-500 transition">
                    <i class="fa-solid fa-lock text-gray-400"></i>
                    <input type="password" id="login-pass" placeholder="å¯†ç " class="flex-1 bg-transparent outline-none text-sm">
                </div>
                
                <!-- ç™»å½•/æ³¨å†Œåˆ‡æ¢ -->
                <div class="flex gap-2">
                    <button id="mode-login-btn" onclick="switchAuthMode('login')" class="flex-1 py-2 text-sm font-bold border-b-2 border-teal-500 text-teal-600 transition">ç™»å½•</button>
                    <button id="mode-signup-btn" onclick="switchAuthMode('signup')" class="flex-1 py-2 text-sm font-bold border-b-2 border-transparent text-gray-400 transition">æ³¨å†Œæ–°è´¦å·</button>
                </div>

                <button onclick="handleAuthSubmit()" class="w-full py-4 bg-teal-600 text-white rounded-xl font-bold text-lg shadow-lg mt-4 active:scale-95 transition-transform" id="auth-submit-btn">ç«‹å³ç™»å½•</button>
            </div>

            <div class="relative my-8 w-full">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-100"></div></div>
                <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-300">æˆ–</span></div>
            </div>

            <button onclick="Auth.loginAsGuest()" class="w-full py-3 bg-white border border-gray-200 text-slate-500 rounded-xl font-bold text-sm transition hover:bg-gray-50">
                <i class="fa-solid fa-user-secret mr-2"></i>æ¸¸å®¢ç›´æ¥è¯•ç”¨
            </button>
        </div>

        <!-- APP ä¸»ç•Œé¢å®¹å™¨ (é»˜è®¤éšè—) -->
        <div id="app-container" class="hidden h-full flex flex-col relative">
            <!-- è§†å›¾ 1: è´¦å• -->
            <div id="view-bill" class="view-page h-full flex flex-col absolute inset-0 bg-slate-50 overflow-hidden">
                <header class="bg-gradient-to-br from-teal-500 to-teal-700 text-white pt-12 pb-16 px-6 relative shrink-0 z-10 rounded-b-[2rem] shadow-lg">
                    <div class="relative z-10 flex justify-between items-start mb-6">
                        <div class="flex items-center gap-2">
                            <div class="flex flex-col"><span class="text-teal-100 text-xs font-medium">å½“å‰è´¦æœŸ</span><div class="flex items-center gap-1"><span class="text-xl font-bold tracking-wide" id="header-date-display">...</span></div></div>
                        </div>
                        <div class="w-8 h-8 rounded-full bg-white/20 backdrop-blur flex items-center justify-center"><i class="fa-solid fa-cloud text-sm" id="sync-status"></i></div>
                    </div>
                    <div class="flex justify-between items-end relative z-10">
                        <div><p class="text-teal-100 text-xs mb-1">æœ¬æœˆæ”¯å‡º</p><div class="flex items-baseline gap-1"><span class="text-3xl font-bold font-mono" id="header-total-expense">0.00</span><span class="text-sm opacity-80">å…ƒ</span></div></div>
                        <div class="text-right"><p class="text-teal-100 text-xs mb-1">æœ¬æœˆæ”¶å…¥</p><p class="text-lg font-medium font-mono" id="header-total-income">0.00</p></div>
                    </div>
                </header>
                <div class="flex-1 overflow-y-auto -mt-8 px-4 pb-24 relative z-20 no-scrollbar">
                    <div id="transaction-list" class="space-y-3 pt-2"></div>
                    <div id="empty-state" class="hidden flex flex-col items-center justify-center py-10 mt-4 opacity-60"><i class="fa-solid fa-file-invoice text-4xl text-gray-300 mb-2"></i><p class="text-gray-400 text-xs">æš‚æ— æ•°æ®</p></div>
                </div>
            </div>

            <!-- è§†å›¾ 2: ç»Ÿè®¡ -->
            <div id="view-stats" class="view-page h-full flex flex-col absolute inset-0 bg-slate-50 overflow-hidden hidden transform translate-x-full transition-transform duration-300">
                <div class="pt-12 px-6 pb-4 bg-white shadow-sm z-10">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">æ”¶æ”¯åˆ†æ</h2>
                    <div class="bg-gray-100 p-1 rounded-xl flex">
                        <button onclick="state.statsType='expense'; renderCharts()" id="st-btn-exp" class="flex-1 py-2 rounded-lg text-xs font-bold bg-white shadow-sm transition">æ”¯å‡º</button>
                        <button onclick="state.statsType='income'; renderCharts()" id="st-btn-inc" class="flex-1 py-2 rounded-lg text-xs font-bold text-gray-400 transition">æ”¶å…¥</button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto px-4 pb-24 no-scrollbar">
                    <div class="bg-white rounded-2xl p-5 shadow-sm mt-4">
                        <h3 class="text-sm font-bold text-slate-700 mb-4 border-l-4 border-teal-500 pl-2">åˆ†ç±»å æ¯”</h3>
                        <div class="h-48 relative"><canvas id="chart-pie"></canvas></div>
                    </div>
                    <div class="bg-white rounded-2xl p-5 shadow-sm mt-4">
                        <h3 class="text-sm font-bold text-slate-700 mb-4 border-l-4 border-teal-500 pl-2">æ¯æ—¥è¶‹åŠ¿</h3>
                        <div class="h-40 relative"><canvas id="chart-line"></canvas></div>
                    </div>
                    <div class="bg-white rounded-2xl p-5 shadow-sm mt-4 mb-4">
                        <h3 class="text-sm font-bold text-slate-700 mb-4 border-l-4 border-teal-500 pl-2">æ’è¡Œæ¦œ</h3>
                        <div id="stats-ranking" class="space-y-4"></div>
                    </div>
                </div>
            </div>

            <!-- è§†å›¾ 3: èµ„äº§ -->
            <div id="view-assets" class="view-page h-full flex flex-col absolute inset-0 bg-slate-50 overflow-hidden hidden transform translate-x-full transition-transform duration-300">
                <div class="pt-12 px-6 pb-6 bg-slate-50 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-slate-800">æˆ‘çš„èµ„äº§</h2>
                    <button onclick="openAssetForm()" class="w-9 h-9 rounded-full bg-white text-slate-500 hover:text-teal-600 shadow-sm flex items-center justify-center transition"><i class="fa-solid fa-plus text-sm"></i></button>
                </div>
                <div class="px-6 mb-4">
                    <div class="bg-slate-800 rounded-2xl p-6 text-white shadow-xl relative overflow-hidden">
                        <div class="absolute right-0 top-0 w-32 h-32 bg-teal-500 opacity-10 rounded-full -mr-10 -mt-10 blur-2xl"></div>
                        <p class="text-slate-400 text-xs font-medium mb-1">å‡€èµ„äº§ (å…ƒ)</p>
                        <h1 class="text-3xl font-bold font-mono tracking-tight mb-6" id="asset-net-total">0.00</h1>
                        <div class="flex gap-8 border-t border-white/10 pt-4">
                            <div><p class="text-[10px] text-slate-400 mb-0.5">æ€»èµ„äº§</p><p class="text-sm font-bold font-mono" id="asset-total-assets">0.00</p></div>
                            <div><p class="text-[10px] text-slate-400 mb-0.5">æ€»è´Ÿå€º</p><p class="text-sm font-bold font-mono text-red-300" id="asset-total-liabilities">0.00</p></div>
                        </div>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto px-4 pb-24 no-scrollbar">
                    <div id="asset-list-container" class="space-y-3"></div>
                </div>
            </div>

            <!-- è§†å›¾ 4: ä¸ªäººä¸­å¿ƒ -->
            <div id="view-mine" class="view-page h-full flex flex-col absolute inset-0 bg-slate-50 overflow-hidden hidden transform translate-x-full transition-transform duration-300">
                <div class="pt-16 pb-16 px-6 bg-gradient-to-br from-teal-50 to-white relative">
                    <div class="flex items-center gap-4 relative z-10">
                        <div class="w-16 h-16 rounded-full bg-teal-100 border-2 border-white shadow-md flex items-center justify-center text-2xl">ğŸ˜</div>
                        <div class="flex-1"><h2 class="text-xl font-bold text-slate-800" id="profile-email">User</h2><div class="text-xs text-slate-500 mt-1">æ•°æ®å·²äº‘ç«¯åŒæ­¥</div></div>
                    </div>
                </div>
                <div class="p-6"><button onclick="handleLogout()" class="w-full py-3 bg-red-50 text-red-500 rounded-xl font-bold text-sm hover:bg-red-100 transition">é€€å‡ºç™»å½•</button></div>
            </div>

            <!-- åº•éƒ¨å¯¼èˆª -->
            <nav class="absolute bottom-0 w-full glass-nav border-t border-gray-100 grid grid-cols-5 items-end h-20 pb-5 z-30">
                <button onclick="switchView('bill')" class="nav-item text-teal-600 flex flex-col items-center justify-center" data-target="bill"><i class="fa-solid fa-file-invoice text-xl mb-1"></i><span class="text-[10px] font-bold">è´¦å•</span></button>
                <button onclick="switchView('stats')" class="nav-item text-gray-300 flex flex-col items-center justify-center" data-target="stats"><i class="fa-solid fa-chart-pie text-xl mb-1"></i><span class="text-[10px] font-bold">ç»Ÿè®¡</span></button>
                <div class="flex justify-center relative -top-5"><button onclick="openAddModal()" class="w-14 h-14 bg-teal-500 rounded-2xl text-white shadow-glow flex items-center justify-center transform transition active:scale-90 hover:-translate-y-1 rotate-45"><i class="fa-solid fa-plus text-2xl -rotate-45"></i></button></div>
                <button onclick="switchView('assets')" class="nav-item text-gray-300 flex flex-col items-center justify-center" data-target="assets"><i class="fa-solid fa-wallet text-xl mb-1"></i><span class="text-[10px] font-bold">èµ„äº§</span></button>
                <button onclick="switchView('mine')" class="nav-item text-gray-300 flex flex-col items-center justify-center" data-target="mine"><i class="fa-solid fa-user text-xl mb-1"></i><span class="text-[10px] font-bold">æˆ‘çš„</span></button>
            </nav>
        </div>

        <!-- è®°è´¦å¼¹çª— -->
        <div id="add-modal" class="absolute inset-0 z-50 hidden flex flex-col justify-end">
            <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm opacity-0 transition-opacity" id="add-backdrop" onclick="closeAddModal()"></div>
            <div class="relative bg-white rounded-t-3xl shadow-2xl h-[85%] flex flex-col translate-y-full transition-transform" id="add-panel">
                <div class="w-full flex justify-center pt-3 pb-1" onclick="closeAddModal()"><div class="w-10 h-1 bg-gray-200 rounded-full"></div></div>
                <div class="px-6 py-2 flex justify-center"><div class="bg-gray-100 p-1 rounded-xl flex w-full max-w-[200px]"><button onclick="setAddType('expense')" id="btn-expense" class="flex-1 py-1.5 rounded-lg text-sm font-bold bg-white shadow-sm transition-all text-slate-800">æ”¯å‡º</button><button onclick="setAddType('income')" id="btn-income" class="flex-1 py-1.5 rounded-lg text-sm font-bold text-gray-400 transition-all">æ”¶å…¥</button></div></div>
                <div class="px-6 py-4 flex flex-col items-end border-b border-gray-50">
                    <div class="flex items-center justify-between w-full mb-2">
                        <div onclick="toggleGridMode()" id="asset-pill" class="flex items-center gap-1.5 px-3 py-1.5 bg-blue-50 text-blue-600 rounded-full cursor-pointer transition active:scale-95"><i class="fa-solid fa-wallet text-xs" id="asset-pill-icon"></i><span class="text-xs font-bold" id="asset-pill-name">é€‰æ‹©è´¦æˆ·</span></div>
                        <input type="text" id="trans-note" placeholder="å†™ç‚¹å¤‡æ³¨..." class="text-right text-xs bg-transparent outline-none w-32">
                    </div>
                    <div class="flex items-baseline gap-1 text-slate-800"><span class="text-2xl font-bold">Â¥</span><div class="text-5xl font-bold tracking-tighter" id="display-amount">0</div></div>
                </div>
                <div class="flex-1 overflow-y-auto px-2 pb-2 relative bg-gray-50/50">
                    <div class="text-xs text-gray-400 font-bold px-4 py-2 sticky top-0 bg-gray-50/95 z-10 flex justify-between backdrop-blur-sm shadow-sm border-b border-gray-100"><span id="grid-title">é€‰æ‹©åˆ†ç±»</span></div>
                    <div class="grid grid-cols-5 gap-y-4 gap-x-1 pt-4 pb-4" id="category-grid"></div>
                </div>
                <div class="bg-gray-50 pb-6 border-t border-gray-100">
                    <div class="grid grid-cols-4 gap-[1px] bg-gray-200 shadow-inner">
                        <button class="key-btn" onclick="appendNumber('7')">7</button><button class="key-btn" onclick="appendNumber('8')">8</button><button class="key-btn" onclick="appendNumber('9')">9</button><button class="key-btn text-sm" onclick="updateDateDisplay()">ä»Šå¤©</button>
                        <button class="key-btn" onclick="appendNumber('4')">4</button><button class="key-btn" onclick="appendNumber('5')">5</button><button class="key-btn" onclick="appendNumber('6')">6</button><button class="key-btn text-teal-500" onclick="appendNumber('+')">+</button>
                        <button class="key-btn" onclick="appendNumber('1')">1</button><button class="key-btn" onclick="appendNumber('2')">2</button><button class="key-btn" onclick="appendNumber('3')">3</button><button class="key-btn text-teal-500" onclick="appendNumber('-')">-</button>
                        <button class="key-btn" onclick="appendNumber('.')">.</button><button class="key-btn" onclick="appendNumber('0')">0</button><button class="key-btn text-slate-400" onclick="deleteNumber()">del</button><button id="keypad-done-btn" class="bg-teal-600 text-white font-bold text-lg active:bg-teal-700" onclick="submitTransaction()">å®Œæˆ</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è´¦å•æ“ä½œèœå• -->
        <div id="tx-action-modal" class="absolute inset-0 z-[60] hidden flex flex-col justify-end">
            <div class="absolute inset-0 bg-black/30 backdrop-blur-sm transition-opacity" onclick="closeTxAction()"></div>
            <div class="relative bg-white rounded-t-3xl p-6 shadow-2xl transition-transform translate-y-full duration-300" id="tx-action-panel">
                <div class="flex justify-between items-center mb-6"><h3 class="text-lg font-bold text-slate-800">è´¦å•è¯¦æƒ…</h3><button onclick="closeTxAction()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500"><i class="fa-solid fa-times"></i></button></div>
                <div class="bg-gray-50 rounded-2xl p-4 mb-6 flex items-center gap-4"><div id="tx-detail-icon" class="w-12 h-12 rounded-full flex items-center justify-center text-xl bg-white shadow-sm text-teal-600"><i class="fa-solid fa-star"></i></div><div class="flex-1"><div class="flex justify-between items-center mb-1"><span class="font-bold text-slate-800 text-lg" id="tx-detail-cat">åˆ†ç±»</span><span class="font-bold text-xl font-mono" id="tx-detail-amount">0.00</span></div><div class="flex justify-between items-center text-xs text-gray-400"><span id="tx-detail-date">æ—¥æœŸ</span><span id="tx-detail-asset" class="bg-white px-2 py-1 rounded border border-gray-100">è´¦æˆ·</span></div><div class="mt-2 text-sm text-gray-600 bg-white/50 p-2 rounded-lg" id="tx-detail-note">æ— å¤‡æ³¨</div></div></div>
                <div class="flex gap-3"><button onclick="editCurrentTx()" class="flex-1 py-3.5 bg-teal-50 text-teal-600 rounded-xl font-bold text-sm hover:bg-teal-100 transition">ç¼–è¾‘</button><button onclick="deleteCurrentTx()" class="flex-1 py-3.5 bg-red-50 text-red-500 rounded-xl font-bold text-sm hover:bg-red-100 transition">åˆ é™¤</button></div>
            </div>
        </div>

        <!-- èµ„äº§è¡¨å•å¼¹çª— -->
        <div id="asset-form-modal" class="absolute inset-0 z-[60] hidden flex flex-col justify-end">
            <div class="absolute inset-0 bg-black/20 backdrop-blur-sm" onclick="closeAssetForm()"></div>
            <div class="relative bg-white rounded-t-3xl h-auto flex flex-col transition-transform translate-y-full duration-300" id="asset-form-panel">
                <div class="px-6 py-4 flex justify-between items-center border-b border-gray-100"><button onclick="closeAssetForm()" class="text-gray-500 text-sm">å–æ¶ˆ</button><h3 class="font-bold text-slate-800" id="asset-form-title">æ·»åŠ è´¦æˆ·</h3><button onclick="saveAssetForm()" class="text-teal-600 font-bold text-sm">ä¿å­˜</button></div>
                <div class="p-6 space-y-5 pb-10"><div><label class="text-xs text-gray-400 font-bold mb-3 block">é€‰æ‹©å›¾æ ‡</label><div class="grid grid-cols-5 gap-4" id="af-icon-grid"></div></div><div class="space-y-3"><div><label class="text-xs text-gray-400 font-bold ml-1">è´¦æˆ·åç§°</label><input id="af-name" class="w-full bg-gray-50 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-teal-100 mt-1" placeholder="å¦‚: ç§æˆ¿é’±"></div><div class="flex gap-4"><div class="flex-1"><label class="text-xs text-gray-400 font-bold ml-1">å½“å‰ä½™é¢</label><input id="af-balance" type="number" class="w-full bg-gray-50 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-teal-100 mt-1" placeholder="0.00"></div><div class="flex-1"><label class="text-xs text-gray-400 font-bold ml-1">ç±»å‹</label><div class="flex bg-gray-100 p-1 rounded-xl mt-1 h-[46px]"><button onclick="setAssetFormType('asset')" id="af-type-asset" class="flex-1 rounded-lg text-xs font-bold transition">èµ„äº§</button><button onclick="setAssetFormType('liability')" id="af-type-liability" class="flex-1 rounded-lg text-xs font-bold transition">è´Ÿå€º</button></div></div></div></div></div></div>
        </div>

    </div>

    <script>
        // --- DATA ---
        let user = null;
        let transactions = [];
        let assetAccounts = [];
        let state = { 
            view: 'bill', date: new Date(), 
            addType: 'expense', input: '0', 
            selCat: null, selAsset: null, 
            gridMode: 'cat', editAssetId: null, tempAssetIcon: null, tempAssetType: 'asset',
            statsType: 'expense', isGuest: false,
            editTxId: null,
            authMode: 'login' // 'login' or 'signup'
        };
        let chartInstances = {};
        
        const categories = { 
            expense: [ {id:'food',name:'é¤é¥®',icon:'fa-utensils',color:'text-orange-500'}, {id:'traffic',name:'äº¤é€š',icon:'fa-train',color:'text-blue-500'}, {id:'shop',name:'è´­ç‰©',icon:'fa-bag-shopping',color:'text-pink-500'}, {id:'ent',name:'å¨±ä¹',icon:'fa-film',color:'text-purple-500'}, {id:'home',name:'å±…ä½',icon:'fa-house',color:'text-teal-500'}, {id:'med',name:'åŒ»ç–—',icon:'fa-notes-medical',color:'text-red-500'}, {id:'other',name:'å…¶ä»–',icon:'fa-circle-notch',color:'text-gray-500'} ],
            income: [ {id:'salary',name:'å·¥èµ„',icon:'fa-money-bill',color:'text-green-500'}, {id:'part',name:'å…¼èŒ',icon:'fa-briefcase',color:'text-blue-500'}, {id:'invest',name:'ç†è´¢',icon:'fa-chart-line',color:'text-red-500'} ]
        };
        const iconPresets = [ { id: 'alipay', icon: 'fa-brands fa-alipay', color: 'text-blue-600', bg: 'bg-blue-50', name: 'æ”¯ä»˜å®' }, { id: 'wechat', icon: 'fa-brands fa-weixin', color: 'text-green-600', bg: 'bg-green-50', name: 'å¾®ä¿¡' }, { id: 'card', icon: 'fa-solid fa-credit-card', color: 'text-indigo-600', bg: 'bg-indigo-50', name: 'é“¶è¡Œå¡' }, { id: 'cash', icon: 'fa-solid fa-wallet', color: 'text-amber-600', bg: 'bg-amber-50', name: 'ç°é‡‘' }, { id: 'invest', icon: 'fa-solid fa-chart-line', color: 'text-red-600', bg: 'bg-red-50', name: 'åŸºé‡‘' }, { id: 'other', icon: 'fa-solid fa-shapes', color: 'text-teal-600', bg: 'bg-teal-50', name: 'å…¶ä»–' } ];

        // --- INIT ---
        window.onload = async () => {
            initSupabase();
            const isGuest = localStorage.getItem('isGuest') === 'true';
            if(isGuest) { Auth.loginAsGuest(); return; }

            if (supabaseClient) {
                const { data } = await supabaseClient.auth.getSession();
                if (data && data.session) {
                    user = data.session.user;
                    showApp();
                    await fetchData();
                } else {
                    document.getElementById('auth-view').classList.remove('hidden');
                }
            } else {
                document.getElementById('auth-view').classList.remove('hidden');
            }
        };

        // --- AUTH V6 (SEPARATED LOGIN/SIGNUP) ---
        function switchAuthMode(mode) {
            state.authMode = mode;
            const btnLogin = document.getElementById('mode-login-btn');
            const btnSignup = document.getElementById('mode-signup-btn');
            const btnSubmit = document.getElementById('auth-submit-btn');
            
            if (mode === 'login') {
                btnLogin.classList.add('border-teal-500', 'text-teal-600');
                btnLogin.classList.remove('border-transparent', 'text-gray-400');
                btnSignup.classList.remove('border-teal-500', 'text-teal-600');
                btnSignup.classList.add('border-transparent', 'text-gray-400');
                btnSubmit.innerText = 'ç«‹å³ç™»å½•';
            } else {
                btnSignup.classList.add('border-teal-500', 'text-teal-600');
                btnSignup.classList.remove('border-transparent', 'text-gray-400');
                btnLogin.classList.remove('border-teal-500', 'text-teal-600');
                btnLogin.classList.add('border-transparent', 'text-gray-400');
                btnSubmit.innerText = 'æ³¨å†Œæ–°è´¦å·';
            }
        }

        async function handleAuthSubmit() {
            if (!supabaseClient) return showToast('ç³»ç»Ÿé”™è¯¯ï¼šæœªè¿æ¥æ•°æ®åº“');
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            if(!email || !pass) return showToast('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ');
            
            const btn = document.getElementById('auth-submit-btn');
            const oldText = btn.innerText;
            btn.innerText = "å¤„ç†ä¸­...";
            btn.disabled = true;

            try {
                if (state.authMode === 'login') {
                    // LOGIN MODE
                    const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password: pass });
                    if (error) throw error;
                    user = data.user;
                    showApp();
                    await fetchData();
                } else {
                    // SIGNUP MODE
                    const { data, error } = await supabaseClient.auth.signUp({ email, password: pass });
                    if (error) throw error;
                    // Auto login often happens after signup if email confirm is off
                    if (data.session) {
                        user = data.user;
                        showApp();
                        await fetchData();
                        showToast('æ³¨å†ŒæˆåŠŸï¼');
                    } else {
                        alert('æ³¨å†ŒæˆåŠŸï¼å¦‚æœå¼€å¯äº†é‚®ç®±éªŒè¯ï¼Œè¯·æŸ¥æ”¶é‚®ä»¶ã€‚');
                        switchAuthMode('login');
                    }
                }
            } catch (err) {
                alert(err.message);
            } finally {
                btn.innerText = oldText;
                btn.disabled = false;
            }
        }

        const Auth = {
            loginAsGuest: () => {
                state.isGuest = true;
                user = { id: 'guest', email: 'Guest@local' };
                localStorage.setItem('isGuest', 'true');
                transactions = JSON.parse(localStorage.getItem('guest_txs') || '[]');
                assetAccounts = JSON.parse(localStorage.getItem('guest_assets') || '[]');
                if(assetAccounts.length === 0) assetAccounts = [{id: 'g_asset_1', name: 'ç°é‡‘', type:'asset', balance:0, icon:'fa-brands fa-wallet', color:'text-teal-600'}];
                state.selCat = categories.expense[0];
                state.selAsset = assetAccounts[0];
                showApp();
                renderAll();
            },
            logout: async () => {
                if(state.isGuest) { localStorage.removeItem('isGuest'); } 
                else if(supabaseClient) { await supabaseClient.auth.signOut(); }
                location.reload();
            }
        };

        function showApp() {
            document.getElementById('auth-view').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            switchView('bill');
        }

        // --- DATA SYNC ---
        async function fetchData() {
            if(state.isGuest) return;
            
            const { data: txs } = await supabaseClient.from('transactions').select('*');
            transactions = txs || [];
            
            const { data: asts } = await supabaseClient.from('assets').select('*');
            assetAccounts = asts || [];
            
            state.selCat = categories.expense[0];
            state.selAsset = assetAccounts.length > 0 ? assetAccounts[0] : null;
            
            renderAll();
        }

        function renderAll() {
            renderNav();
            if(state.view === 'bill') renderBill();
            else if(state.view === 'assets') renderAssets();
            else if(state.view === 'mine') renderMine();
            else if(state.view === 'stats') setTimeout(renderCharts, 100);
        }

        function renderNav() {
            document.querySelectorAll('.nav-item').forEach(el => {
                if(el.dataset.target === state.view) { el.classList.add('text-teal-600'); el.classList.remove('text-gray-300'); } 
                else { el.classList.remove('text-teal-600'); el.classList.add('text-gray-300'); }
            });
        }

        function switchView(v) { 
            state.view = v; 
            document.querySelectorAll('.view-page').forEach(e=>e.classList.add('hidden')); 
            const target = document.getElementById('view-'+v);
            target.classList.remove('hidden');
            setTimeout(()=>target.classList.remove('translate-x-full'), 10);
            renderNav(); 
            if(v === 'bill') renderBill();
            else if(v === 'assets') renderAssets();
            else if(v === 'mine') renderMine();
            else if(v === 'stats') setTimeout(renderCharts, 100);
        }

        // --- RENDERERS ---
        function renderBill() {
            const list = document.getElementById('transaction-list'); list.innerHTML = '';
            const y = state.date.getFullYear(), m = state.date.getMonth();
            document.getElementById('header-date-display').innerText = `${y}å¹´${m+1}æœˆ`;
            const curr = transactions.filter(t => { const d = new Date(t.date); return d.getFullYear()===y && d.getMonth()===m; });
            const exp = curr.filter(t=>t.type==='expense').reduce((a,b)=>a+b.amount,0);
            const inc = curr.filter(t=>t.type==='income').reduce((a,b)=>a+b.amount,0);
            document.getElementById('header-total-expense').innerText = exp.toFixed(2);
            document.getElementById('header-total-income').innerText = inc.toFixed(2);
            document.getElementById('empty-state').classList.toggle('hidden', curr.length > 0);
            
            curr.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(t => {
                const cat = [...categories.expense, ...categories.income].find(c=>c.id===t.category) || {name:t.category, icon:'fa-question', color:'text-gray-500'};
                const asset = assetAccounts.find(a => a.id == t.asset_id);
                list.innerHTML += `<div class="bg-white p-4 rounded-2xl flex items-center gap-4 mb-3 shadow-soft border border-slate-50 cursor-pointer active:scale-[0.98] transition" onclick="openTxAction('${t.id}')"><div class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-100 ${cat.color} text-lg"><i class="fa-solid ${cat.icon}"></i></div><div class="flex-1 min-w-0"><div class="flex justify-between items-baseline mb-1"><span class="text-sm font-bold text-slate-800">${cat.name}</span><span class="font-bold ${t.type==='expense'?'text-slate-800':'text-teal-600'}">${t.type==='expense'?'-':'+'}${t.amount}</span></div><div class="flex justify-between items-center text-xs text-slate-400"><div class="flex items-center gap-2"><span>${new Date(t.date).getDate()}æ—¥</span>${asset ? `<span class="bg-slate-100 px-1.5 rounded text-slate-500">${asset.name}</span>` : ''}</div><span class="truncate max-w-[100px]">${t.note||''}</span></div></div></div>`;
            });
        }
        function renderAssets() {
            const list = document.getElementById('asset-list-container'); list.innerHTML = '';
            let net = 0, totA = 0, totL = 0;
            assetAccounts.forEach(a => {
                if(a.type === 'asset') totA += a.balance; else totL += a.balance;
                const preset = iconPresets.find(p => p.icon === a.icon) || iconPresets[3];
                // Use strict == for ID match
                list.innerHTML += `<div class="flex items-center p-4 bg-white rounded-2xl shadow-soft border border-slate-50 mb-3 cursor-pointer active:scale-[0.98] transition" onclick="openAssetForm('${a.id}')"><div class="w-12 h-12 rounded-full ${preset.bg} flex items-center justify-center ${preset.color} text-xl mr-4"><i class="${a.icon||'fa-solid fa-wallet'}"></i></div><div class="flex-1"><div class="font-bold text-slate-700 text-sm">${a.name}</div><div class="text-xs text-gray-400 mt-0.5">${a.type==='asset'?'èµ„äº§':'è´Ÿå€º'}</div></div><div class="text-right"><div class="font-bold text-slate-800">Â¥${a.balance.toFixed(2)}</div><div class="text-[10px] text-gray-300"><i class="fa-solid fa-pen"></i></div></div></div>`;
            });
            net = totA - totL; document.getElementById('asset-net-total').innerText = net.toFixed(2); document.getElementById('asset-total-assets').innerText = totA.toFixed(2); document.getElementById('asset-total-liabilities').innerText = totL.toFixed(2);
        }
        function renderMine() { 
            if(user) document.getElementById('profile-email').innerText = user.email.split('@')[0];
        }
        function renderCharts() {
            const btnExp = document.getElementById('st-btn-exp'), btnInc = document.getElementById('st-btn-inc');
            if(state.statsType==='expense') { btnExp.className="flex-1 py-2 rounded-lg text-xs font-bold bg-slate-800 text-white shadow-sm transition"; btnInc.className="flex-1 py-2 rounded-lg text-xs font-bold text-gray-400 transition"; } 
            else { btnInc.className="flex-1 py-2 rounded-lg text-xs font-bold bg-slate-800 text-white shadow-sm transition"; btnExp.className="flex-1 py-2 rounded-lg text-xs font-bold text-gray-400 transition"; }

            const y = state.date.getFullYear(), m = state.date.getMonth();
            const currTxs = transactions.filter(t => { const d = new Date(t.date); return d.getFullYear()===y && d.getMonth()===m && t.type===state.statsType; });

            const catMap = {}; let total = 0;
            currTxs.forEach(t => { catMap[t.category] = (catMap[t.category] || 0) + t.amount; total += t.amount; });
            const sortedCats = Object.keys(catMap).sort((a,b) => catMap[b] - catMap[a]);
            const daysInMonth = new Date(y, m+1, 0).getDate();
            const dayData = new Array(daysInMonth).fill(0);
            currTxs.forEach(t => { dayData[new Date(t.date).getDate()-1] += t.amount; });

            if(chartInstances.pie) chartInstances.pie.destroy();
            if(chartInstances.line) chartInstances.line.destroy();

            chartInstances.pie = new Chart(document.getElementById('chart-pie').getContext('2d'), { type: 'doughnut', data: { labels: sortedCats.map(c => ([...categories.expense, ...categories.income].find(i=>i.id===c)?.name || c)), datasets: [{ data: sortedCats.map(c => catMap[c]), backgroundColor: ['#14b8a6', '#f59e0b', '#3b82f6', '#ef4444', '#8b5cf6'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: {size: 10} } } }, cutout: '70%' } });
            chartInstances.line = new Chart(document.getElementById('chart-line').getContext('2d'), { type: 'line', data: { labels: Array.from({length: daysInMonth}, (_, i) => i + 1), datasets: [{ label: state.statsType==='expense'?'æ”¯å‡º':'æ”¶å…¥', data: dayData, borderColor: state.statsType==='expense'?'#14b8a6':'#f59e0b', tension: 0.4, pointRadius: 2, borderWidth: 2, fill: true, backgroundColor: state.statsType==='expense'?'rgba(20, 184, 166, 0.1)':'rgba(245, 158, 11, 0.1)' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { maxTicksLimit: 7 } }, y: { display: false } } } });

            const rankEl = document.getElementById('stats-ranking'); rankEl.innerHTML = '';
            if(sortedCats.length === 0) rankEl.innerHTML = '<p class="text-center text-xs text-gray-400 py-4">æš‚æ— æ•°æ®</p>';
            else sortedCats.forEach(cid => { const amt = catMap[cid], pct = ((amt/total)*100).toFixed(1); const cat = [...categories.expense, ...categories.income].find(c=>c.id===cid) || {name:cid}; rankEl.innerHTML += `<div class="flex items-center justify-between text-sm"><div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-teal-500"></div><span class="text-slate-600">${cat.name}</span></div><div class="flex items-center gap-3"><span class="text-xs text-gray-400">${pct}%</span><span class="font-bold text-slate-700">Â¥${amt.toFixed(2)}</span></div></div><div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden mb-1"><div class="h-full bg-teal-500" style="width: ${pct}%"></div></div>`; });
        }

        // --- CRUD LOGIC ---
        function openAddModal(isEdit=false) { 
            document.getElementById('add-modal').classList.remove('hidden'); document.getElementById('add-backdrop').classList.remove('opacity-0'); setTimeout(()=>document.getElementById('add-panel').classList.remove('translate-y-full'),10); 
            if (!isEdit) { state.input='0'; state.editTxId = null; state.selCat = categories.expense[0]; state.selAsset = assetAccounts.length > 0 ? assetAccounts[0] : null; document.getElementById('trans-note').value = ''; setAddType('expense'); }
            updateDisplay(); setupGrid(); updatePillUI(); 
        }
        function closeAddModal() { document.getElementById('add-panel').classList.add('translate-y-full'); document.getElementById('add-backdrop').classList.add('opacity-0'); setTimeout(()=>document.getElementById('add-modal').classList.add('hidden'),300); }
        function setAddType(t) { state.addType=t; document.getElementById('btn-expense').className = t==='expense'?'flex-1 py-1.5 rounded-lg text-sm font-bold bg-white shadow-sm transition-all text-slate-800':'flex-1 py-1.5 rounded-lg text-sm font-bold text-gray-400 transition-all'; document.getElementById('btn-income').className = t==='income'?'flex-1 py-1.5 rounded-lg text-sm font-bold bg-white shadow-sm transition-all text-slate-800':'flex-1 py-1.5 rounded-lg text-sm font-bold text-gray-400 transition-all'; setupGrid(); }
        function toggleGridMode() { state.gridMode = state.gridMode==='cat'?'asset':'cat'; setupGrid(); }
        function setupGrid() {
            const grid = document.getElementById('category-grid'), title = document.getElementById('grid-title'); grid.innerHTML = '';
            if(state.gridMode === 'cat') { title.innerText = 'é€‰æ‹©åˆ†ç±»'; (state.addType==='expense'?categories.expense:categories.income).forEach(c => { const isSel = state.selCat && state.selCat.id === c.id; grid.innerHTML += `<div class="flex flex-col items-center gap-2 transition-all" onclick="state.selCat={id:'${c.id}',name:'${c.name}'}; setupGrid();"><div class="w-12 h-12 rounded-full flex items-center justify-center text-lg ${isSel?'bg-slate-800 text-white shadow-lg':'bg-white text-slate-500 shadow-sm'}"><i class="fa-solid ${c.icon}"></i></div><span class="text-[10px] font-medium text-slate-500">${c.name}</span></div>`; }); } 
            else { title.innerText = 'é€‰æ‹©å…³è”è´¦æˆ·'; assetAccounts.forEach(a => { const isSel = state.selAsset && state.selAsset.id == a.id; const preset = iconPresets.find(p => p.icon === a.icon) || iconPresets[0]; const ring = isSel ? 'ring-2 ring-offset-2 ring-blue-500' : ''; grid.innerHTML += `<div class="flex flex-col items-center gap-2 transition-all" onclick="state.selAsset={id:'${a.id}',name:'${a.name}',icon:'${a.icon}'}; toggleGridMode(); updatePillUI();"><div class="w-12 h-12 rounded-full flex items-center justify-center text-lg ${preset.bg} ${preset.color} ${ring}"><i class="${a.icon||'fa-solid fa-wallet'}"></i></div><span class="text-[10px] font-medium text-slate-500 truncate max-w-[60px]">${a.name}</span></div>`; }); }
        }
        function updatePillUI() { const pill = document.getElementById('asset-pill'); if(state.selAsset) { document.getElementById('asset-pill-name').innerText = state.selAsset.name; document.getElementById('asset-pill-icon').className = state.selAsset.icon || 'fa-solid fa-wallet'; pill.className = `flex items-center gap-1.5 px-3 py-1.5 bg-white border border-blue-100 text-blue-600 rounded-full cursor-pointer transition active:scale-95 shadow-sm`; } else { document.getElementById('asset-pill-name').innerText = 'é€‰æ‹©è´¦æˆ·'; pill.className = `flex items-center gap-1.5 px-3 py-1.5 bg-gray-100 text-gray-400 rounded-full cursor-pointer transition active:scale-95`; } }
        
        async function submitTransaction() {
            const val = parseFloat(state.input); if(!val) return showToast('è¯·è¾“å…¥é‡‘é¢');
            const newTxData = { user_id: user.id, amount: val, type: state.addType, category: state.selCat.id, asset_id: state.selAsset?.id, date: new Date().toISOString(), note: document.getElementById('trans-note').value };

            // GUEST
            if(state.isGuest) {
                if (state.editTxId) {
                    const idx = transactions.findIndex(t => t.id == state.editTxId);
                    const oldTx = transactions[idx];
                    if (oldTx.asset_id) { const a = assetAccounts.find(x=>x.id==oldTx.asset_id); if(a) a.balance += (oldTx.type==='expense'?oldTx.amount:-oldTx.amount); }
                    if (state.selAsset) { const a = assetAccounts.find(x=>x.id==state.selAsset.id); if(a) a.balance += (state.addType==='expense'?-val:val); }
                    transactions[idx] = { ...newTxData, id: state.editTxId };
                } else {
                    newTxData.id = Date.now(); transactions.unshift(newTxData);
                    if(state.selAsset) { const a = assetAccounts.find(x=>x.id==state.selAsset.id); if(a) a.balance += (state.addType==='expense'?-val:val); }
                }
                localStorage.setItem('guest_txs', JSON.stringify(transactions)); localStorage.setItem('guest_assets', JSON.stringify(assetAccounts));
                closeAddModal(); renderAll(); showToast('ä¿å­˜æˆåŠŸ'); return;
            }

            // CLOUD (Fix: No ID sent)
            if (state.editTxId) {
                const oldTx = transactions.find(t => t.id == state.editTxId);
                if (oldTx && oldTx.asset_id) { const a = assetAccounts.find(x=>x.id == oldTx.asset_id); if(a) { let rb = parseFloat(a.balance)+(oldTx.type==='expense'?oldTx.amount:-oldTx.amount); await supabaseClient.from('assets').update({balance:rb}).eq('id', a.id); } }
                await supabaseClient.from('transactions').update(newTxData).eq('id', state.editTxId);
                if (state.selAsset) { const a = assetAccounts.find(x=>x.id == state.selAsset.id); let nb = parseFloat(a.balance)+(state.addType==='expense'?-val:val); await supabaseClient.from('assets').update({balance:nb}).eq('id', a.id); }
            } else {
                delete newTxData.id; 
                await supabaseClient.from('transactions').insert([newTxData]);
                if(state.selAsset) { const a = assetAccounts.find(x=>x.id==state.selAsset.id); let nb = parseFloat(a.balance)+(state.addType==='expense'?-val:val); await supabaseClient.from('assets').update({balance:nb}).eq('id', a.id); }
            }
            closeAddModal(); await fetchData(); showToast('ä¿å­˜æˆåŠŸ');
        }

        function openTxAction(id) {
            state.activeTxId = id; const tx = transactions.find(t => t.id == id); const cat = [...categories.expense, ...categories.income].find(c=>c.id===tx.category) || {name:tx.category, icon:'fa-question', color:'text-gray-500'}; const asset = assetAccounts.find(a => a.id == tx.asset_id);
            document.getElementById('tx-detail-amount').innerText = (tx.type==='expense'?'-':'+') + tx.amount; document.getElementById('tx-detail-amount').className = `font-bold text-xl font-mono ${tx.type==='expense'?'text-slate-800':'text-teal-600'}`; document.getElementById('tx-detail-cat').innerText = cat.name; document.getElementById('tx-detail-date').innerText = new Date(tx.date).toLocaleString(); document.getElementById('tx-detail-asset').innerText = asset ? asset.name : 'æ— è´¦æˆ·'; document.getElementById('tx-detail-note').innerText = tx.note || 'æ— å¤‡æ³¨';
            const m = document.getElementById('tx-action-modal'), p = document.getElementById('tx-action-panel'); m.classList.remove('hidden'); setTimeout(()=>p.classList.remove('translate-y-full'), 10);
        }
        function closeTxAction() { const m = document.getElementById('tx-action-modal'), p = document.getElementById('tx-action-panel'); p.classList.add('translate-y-full'); setTimeout(()=>m.classList.add('hidden'), 300); }
        function editCurrentTx() { closeTxAction(); const tx = transactions.find(t => t.id == state.activeTxId); if(!tx) return; state.editTxId = tx.id; state.input = tx.amount.toString(); state.addType = tx.type; state.selCat = [...categories.expense, ...categories.income].find(c=>c.id===tx.category); state.selAsset = assetAccounts.find(a=>a.id == tx.asset_id); document.getElementById('trans-note').value = tx.note || ''; setAddType(tx.type); openAddModal(true); }
        async function deleteCurrentTx() {
            if(!confirm('åˆ é™¤æ­¤è®°å½•å¹¶å›æ»šä½™é¢?')) return;
            const tx = transactions.find(t => t.id == state.activeTxId);
            if(state.isGuest) {
                if(tx.asset_id) { const a = assetAccounts.find(x=>x.id==tx.asset_id); if(a) a.balance += (tx.type==='expense' ? tx.amount : -tx.amount); }
                transactions = transactions.filter(t=>t.id!=state.activeTxId);
                localStorage.setItem('guest_txs', JSON.stringify(transactions)); localStorage.setItem('guest_assets', JSON.stringify(assetAccounts));
            } else {
                if(tx.asset_id) { const a = assetAccounts.find(x=>x.id==tx.asset_id); if(a) { let nb = a.balance + (tx.type==='expense' ? tx.amount : -tx.amount); await supabaseClient.from('assets').update({balance: nb}).eq('id', a.id); } }
                await supabaseClient.from('transactions').delete().eq('id', state.activeTxId);
            }
            closeTxAction(); await fetchData(); showToast('å·²åˆ é™¤');
        }

        // Asset Form
        function openAssetForm(id=null) { state.editAssetId = id; const modal = document.getElementById('asset-form-modal'); if (id) { const acc = assetAccounts.find(a => a.id == id); document.getElementById('asset-form-title').innerText = 'ç¼–è¾‘è´¦æˆ·'; document.getElementById('af-name').value = acc.name; document.getElementById('af-balance').value = acc.balance; state.tempAssetIcon = { icon: acc.icon, color: acc.color }; state.tempAssetType = acc.type; } else { document.getElementById('asset-form-title').innerText = 'æ·»åŠ è´¦æˆ·'; document.getElementById('af-name').value = ''; document.getElementById('af-balance').value = ''; state.tempAssetIcon = iconPresets[0]; state.tempAssetType = 'asset'; } updateAssetFormUI(); renderAssetIconGrid(); modal.classList.remove('hidden'); setTimeout(() => document.getElementById('asset-form-panel').classList.remove('translate-y-full'), 10); }
        function closeAssetForm() { document.getElementById('asset-form-panel').classList.add('translate-y-full'); setTimeout(() => document.getElementById('asset-form-modal').classList.add('hidden'),300); }
        function setAssetFormType(type) { state.tempAssetType = type; updateAssetFormUI(); }
        function updateAssetFormUI() { const tAsset = document.getElementById('af-type-asset'); const tLiab = document.getElementById('af-type-liability'); if (state.tempAssetType === 'asset') { tAsset.className = 'flex-1 py-2.5 rounded-lg bg-white shadow text-teal-700 font-bold text-xs transition border border-teal-100'; tLiab.className = 'flex-1 py-2.5 rounded-lg text-gray-400 font-medium text-xs transition hover:bg-gray-200'; } else { tAsset.className = 'flex-1 py-2.5 rounded-lg text-gray-400 font-medium text-xs transition hover:bg-gray-200'; tLiab.className = 'flex-1 py-2.5 rounded-lg bg-white shadow text-red-600 font-bold text-xs transition border border-red-100'; } }
        function renderAssetIconGrid() { const grid = document.getElementById('af-icon-grid'); grid.innerHTML = ''; iconPresets.forEach(p => { const isActive = p.icon === state.tempAssetIcon.icon; const el = document.createElement('div'); el.className = `flex flex-col items-center gap-1 cursor-pointer transition-all duration-200`; el.innerHTML = `<div class="w-10 h-10 rounded-full flex items-center justify-center text-lg ${p.bg} ${p.color} ${isActive?'ring-2 ring-offset-2 ring-slate-800 scale-110':'opacity-60 grayscale'} transition-all"><i class="${p.icon}"></i></div><span class="text-[10px] text-slate-500 font-medium">${p.name}</span>`; el.onclick = () => { state.tempAssetIcon = p; renderAssetIconGrid(); }; grid.appendChild(el); }); }
        
        async function saveAssetForm() {
            const name = document.getElementById('af-name').value; if(!name) return showToast('è¯·è¾“å…¥åç§°');
            const bal = parseFloat(document.getElementById('af-balance').value)||0;
            const payload = { user_id: user.id, name, balance: bal, type: state.tempAssetType, icon: state.tempAssetIcon.icon, color: state.tempAssetIcon.color };
            
            if(state.isGuest) {
                if(state.editAssetId) { const idx = assetAccounts.findIndex(a=>a.id == state.editAssetId); if(idx!==-1) assetAccounts[idx] = { ...assetAccounts[idx], ...payload }; } 
                else { payload.id = Date.now(); assetAccounts.push(payload); }
                localStorage.setItem('guest_assets', JSON.stringify(assetAccounts)); closeAssetForm(); renderAll(); return;
            }

            if (!supabaseClient) return;
            if (state.editAssetId) { await supabaseClient.from('assets').update(payload).eq('id', state.editAssetId); showToast('å·²ä¿®æ”¹'); } 
            else { delete payload.id; await supabaseClient.from('assets').insert([payload]); showToast('å·²æ·»åŠ '); } 
            closeAssetForm(); await fetchData(); 
        }

        // Utils
        function appendNumber(n) { if(state.input==='0'&&n!=='.') state.input=''; state.input+=n; updateDisplay(); }
        function deleteNumber() { state.input=state.input.slice(0,-1)||'0'; updateDisplay(); }
        function updateDisplay() { document.getElementById('display-amount').innerText = state.input; }
        function showToast(m) { const t=document.createElement('div'); t.className='toast'; t.innerText=m; document.getElementById('toast-container').appendChild(t); setTimeout(()=>t.remove(),2000); }
        function updateDateDisplay() { document.getElementById('keypad-date').innerText = new Date().getDate() + 'æ—¥'; }
    </script>
</body>
</html>
