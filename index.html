<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>随手记 Cloud Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 引入 Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        teal: { 50: '#f0fdfa', 100: '#ccfbf1', 400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488', 800: '#115e59', 900: '#134e4a' },
                        stone: { 50: '#fafaf9', 100: '#f5f5f4', 200: '#e7e5e4', 300: '#d6d3d1', 800: '#292524', 900: '#1c1917' },
                    },
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.05)',
                        'card': '0 2px 20px rgba(0, 0, 0, 0.02), 0 10px 40px rgba(0, 0, 0, 0.04)',
                    },
                    animation: {
                        'blob': 'blob 7s infinite',
                        'fade-in': 'fadeIn 0.5s ease-out forwards'
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        }
                    }
                }
            }
        }

        // --- SUPABASE 配置 (使用你提供的 Key) ---
        const SUPABASE_URL = 'https://dokkfbtuusvmofqlkxal.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRva2tmYnR1dXN2bW9mcWxreGFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwMTczNzgsImV4cCI6MjA4NTU5MzM3OH0.jFg3q_clPEIRw6Wtjxgvk2s-bA1df2AM0MRuNMGYfTg';
        
        let supabaseClient = null;

        function initSupabase() {
            if (window.supabase) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            }
        }
    </script>
    <style>
        body { background-color: #f5f5f4; color: #292524; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 3px; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
        
        .modern-input {
            background-color: #f5f5f4;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .modern-input:focus {
            background-color: white;
            border-color: #14b8a6;
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
            outline: none;
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(20, 184, 166, 0.3);
        }
        .hidden-view { display: none !important; }
    </style>
</head>
<body class="font-sans selection:bg-teal-100 selection:text-teal-900">

    <!-- 1. 登录界面 -->
    <div id="auth-view" class="fixed inset-0 z-50 flex items-center justify-center bg-[#f0f2f5] overflow-hidden">
        <div class="absolute top-0 -left-4 w-96 h-96 bg-teal-200 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob"></div>
        <div class="absolute top-0 -right-4 w-96 h-96 bg-purple-200 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-2000"></div>
        
        <div class="glass-panel w-full max-w-md p-8 rounded-3xl shadow-xl relative animate-fade-in mx-4">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-br from-teal-400 to-teal-600 rounded-2xl flex items-center justify-center text-white text-2xl shadow-lg mx-auto mb-4">
                    <i class="fa-solid fa-cloud"></i>
                </div>
                <h2 class="text-2xl font-bold text-stone-800">随手记 Cloud</h2>
                <p class="text-stone-500 text-sm mt-1">桌面云端同步版</p>
            </div>

            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-semibold text-stone-500 uppercase tracking-wider mb-1 ml-1">邮箱</label>
                    <input type="email" id="login-email" class="modern-input w-full px-4 py-3 rounded-xl font-medium text-stone-700" placeholder="name@example.com">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-stone-500 uppercase tracking-wider mb-1 ml-1">密码</label>
                    <input type="password" id="login-pass" class="modern-input w-full px-4 py-3 rounded-xl font-medium text-stone-700" placeholder="••••••">
                </div>
                
                <button type="submit" id="login-btn" class="w-full bg-stone-800 hover:bg-black text-white py-3.5 rounded-xl font-bold transition shadow-lg flex items-center justify-center gap-2">
                    登录 / 自动注册
                </button>
            </form>

            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>
                <div class="relative flex justify-center text-sm"><span class="px-2 bg-white/50 text-gray-500 bg-opacity-50">或</span></div>
            </div>

            <button onclick="Auth.loginAsGuest()" class="w-full bg-white border border-stone-200 text-stone-600 hover:bg-stone-50 py-3 rounded-xl font-bold transition shadow-sm flex items-center justify-center gap-2">
                <i class="fa-solid fa-user-secret"></i> 游客直接试用 (离线模式)
            </button>

            <p id="login-msg" class="text-center text-xs text-red-500 mt-4 min-h-[1rem]"></p>
        </div>
    </div>

    <!-- 2. 主应用界面 -->
    <div id="app-view" class="flex h-screen hidden-view animate-fade-in opacity-0">
        <!-- 侧边栏 -->
        <aside class="w-64 flex-none bg-white border-r border-stone-100 flex flex-col z-20 shadow-sm">
            <div class="h-20 flex items-center px-8">
                <div class="w-8 h-8 bg-gradient-to-br from-teal-400 to-teal-600 rounded-lg flex items-center justify-center text-white shadow-lg mr-3">
                    <i class="fa-solid fa-cloud"></i>
                </div>
                <span class="font-bold text-xl tracking-tight text-stone-800">Cloud Pro</span>
            </div>

            <nav class="flex-1 px-4 py-6 space-y-2">
                <button onclick="Router.navigate('dashboard')" class="nav-item active w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium" data-tab="dashboard">
                    <i class="fa-solid fa-layer-group w-5 text-center"></i> 仪表盘
                </button>
                <button onclick="Router.navigate('analysis')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-stone-500 text-sm font-medium" data-tab="analysis">
                    <i class="fa-solid fa-chart-pie w-5 text-center"></i> 收支分析
                </button>
                <button onclick="Router.navigate('transactions')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-stone-500 text-sm font-medium" data-tab="transactions">
                    <i class="fa-solid fa-list-ul w-5 text-center"></i> 账单明细
                </button>
            </nav>

            <div class="p-4 border-t border-stone-100">
                <div class="flex items-center gap-3 px-4 py-2 rounded-xl bg-stone-50 border border-stone-100 mb-2">
                    <div class="w-8 h-8 rounded-full bg-teal-100 text-teal-600 flex items-center justify-center font-bold text-xs" id="user-avatar">G</div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-stone-800 truncate" id="user-email">Guest</p>
                        <p class="text-[10px] flex items-center gap-1" id="user-status"><span class="w-1.5 h-1.5 rounded-full bg-gray-400"></span> 离线模式</p>
                    </div>
                </div>
                <button onclick="Auth.logout()" class="w-full text-xs text-stone-400 hover:text-red-500 py-2 transition">退出 / 切换账号</button>
            </div>
        </aside>

        <!-- 主内容区 -->
        <main class="flex-1 flex flex-col relative overflow-hidden bg-[#F8FAFC]">
            <header class="h-20 flex-none px-8 flex items-center justify-between z-10">
                <div>
                    <h2 id="page-title" class="text-2xl font-bold text-stone-800 tracking-tight">概览</h2>
                    <p class="text-xs text-stone-400 font-medium mt-1" id="current-date">...</p>
                </div>
                <button onclick="DataService.fetch()" class="w-10 h-10 bg-white rounded-full border border-stone-200 shadow-sm flex items-center justify-center text-stone-500 hover:text-teal-600 transition" title="刷新数据">
                    <i class="fa-solid fa-rotate"></i>
                </button>
            </header>

            <div id="main-view" class="flex-1 overflow-y-auto px-8 pb-8 pt-2">
                <!-- 动态内容 -->
            </div>
        </main>
    </div>

    <!-- 提示框 -->
    <div id="toast-container" class="fixed top-8 left-1/2 transform -translate-x-1/2 pointer-events-none z-50 transition-all duration-300 opacity-0 translate-y-[-20px]">
        <div class="glass-panel px-6 py-3 rounded-full shadow-float text-sm font-medium flex items-center gap-2 text-stone-700">
            <i class="fa-solid fa-circle-check text-teal-500"></i>
            <span id="toast-msg">操作成功</span>
        </div>
    </div>

    <script>
        // --- 全局状态 ---
        const State = {
            user: null,
            isGuest: false,
            transactions: [], 
            categories: {
                expense: [
                    { id: 'food', name: '餐饮美食', icon: 'fa-utensils', color: '#f87171' },
                    { id: 'shop', name: '日常购物', icon: 'fa-bag-shopping', color: '#fb923c' },
                    { id: 'transport', name: '交通出行', icon: 'fa-bus', color: '#38bdf8' },
                    { id: 'home', name: '居住缴费', icon: 'fa-house', color: '#a78bfa' },
                    { id: 'ent', name: '休闲娱乐', icon: 'fa-film', color: '#e879f9' },
                    { id: 'med', name: '医疗健康', icon: 'fa-notes-medical', color: '#ef4444' },
                    { id: 'study', name: '教育学习', icon: 'fa-graduation-cap', color: '#4ade80' },
                    { id: 'other', name: '其他支出', icon: 'fa-circle-notch', color: '#94a3b8' }
                ],
                income: [
                    { id: 'salary', name: '工资收入', icon: 'fa-money-bill-wave', color: '#facc15' },
                    { id: 'part', name: '兼职收入', icon: 'fa-briefcase', color: '#2dd4bf' },
                    { id: 'other-in', name: '其他收入', icon: 'fa-circle-plus', color: '#94a3b8' }
                ]
            },
            input: { type: 'expense', category: 'food' }
        };

        // --- 1. 认证服务 (混合模式) ---
        const Auth = {
            async init() {
                initSupabase();
                
                const guestMark = localStorage.getItem('shouji_is_guest');
                if (guestMark === 'true') {
                    this.loginAsGuest();
                    return;
                }

                if(supabaseClient) {
                    const { data } = await supabaseClient.auth.getSession();
                    if (data.session) {
                        this.setUser(data.session.user, false);
                    } else {
                        this.showLogin();
                    }
                } else {
                    this.showLogin();
                }

                document.getElementById('login-form').addEventListener('submit', this.handleLogin);
            },

            loginAsGuest() {
                localStorage.setItem('shouji_is_guest', 'true');
                const guestUser = { id: 'guest', email: 'Guest@local' };
                this.setUser(guestUser, true);
                Helpers.showToast('已进入离线模式');
            },

            async handleLogin(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-pass').value;
                const btn = document.getElementById('login-btn');
                const msg = document.getElementById('login-msg');

                if (!email || !password) {
                    msg.innerText = "请输入邮箱和密码";
                    return;
                }

                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> 处理中...';
                msg.innerText = "";

                // 先尝试登录
                let { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

                if (error) {
                    if (error.message.includes('rate limit')) {
                        msg.innerText = "⚠️ 操作太频繁，请稍后再试，或使用游客模式";
                        btn.disabled = false;
                        btn.innerText = "登录 / 自动注册";
                        return;
                    }

                    // 登录失败则尝试注册
                    const res = await supabaseClient.auth.signUp({ email, password });
                    
                    if (res.error) {
                        const errMsg = res.error.message.toLowerCase();
                        if (errMsg.includes('rate limit')) {
                             msg.innerText = "⚠️ 注册太频繁，请先使用游客模式";
                        } else if (errMsg.includes('signups are disabled') || errMsg.includes('signup is disabled')) {
                             msg.innerText = "⚠️ 云端注册功能未开启 (请在 Supabase 后台开启 Enable Email Provider)";
                        } else {
                             msg.innerText = "错误: " + res.error.message;
                        }
                        btn.disabled = false;
                        btn.innerText = "登录 / 自动注册";
                        return;
                    }
                    data = res.data;
                    Helpers.showToast("注册成功并登录");
                }

                if (data.user) {
                    Auth.setUser(data.user, false);
                }
            },

            setUser(user, isGuest) {
                State.user = user;
                State.isGuest = isGuest;
                
                document.getElementById('auth-view').classList.add('hidden-view');
                const app = document.getElementById('app-view');
                app.classList.remove('hidden-view');
                setTimeout(() => app.classList.remove('opacity-0'), 100);

                const name = user.email ? user.email.split('@')[0] : 'Guest';
                document.getElementById('user-email').innerText = name;
                document.getElementById('user-avatar').innerText = name[0].toUpperCase();

                const statusEl = document.getElementById('user-status');
                if (isGuest) {
                    statusEl.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-gray-400"></span> 离线模式';
                    statusEl.className = "text-[10px] flex items-center gap-1 text-gray-500";
                } else {
                    statusEl.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> 已连接云端';
                    statusEl.className = "text-[10px] flex items-center gap-1 text-green-600";
                }

                DataService.fetch();
                Router.navigate('dashboard');
            },

            async logout() {
                if(confirm('确定退出？')) {
                    if (State.isGuest) {
                        localStorage.removeItem('shouji_is_guest');
                    } else if (supabaseClient) {
                        await supabaseClient.auth.signOut();
                    }
                    window.location.reload();
                }
            },

            showLogin() {
                document.getElementById('app-view').classList.add('hidden-view');
                document.getElementById('auth-view').classList.remove('hidden-view');
            }
        };

        // --- 2. 数据服务 ---
        const DataService = {
            async fetch() {
                if (!State.user) return;
                
                if (State.isGuest) {
                    const localData = localStorage.getItem('shouji_guest_data');
                    State.transactions = localData ? JSON.parse(localData) : [];
                    Router.refresh();
                } else {
                    const { data, error } = await supabaseClient
                        .from('transactions')
                        .select('*')
                        .order('date', { ascending: false });
                    
                    if (data) {
                        State.transactions = data;
                        Router.refresh(); 
                    }
                }
            },

            async add(payload) {
                // 构造基础数据
                const txData = {
                    user_id: State.user.id,
                    amount: payload.amount,
                    type: payload.type,
                    category: payload.category,
                    note: payload.note,
                    date: payload.date
                };

                if (State.isGuest) {
                    // [GUEST] 本地模式：必须手动生成 ID
                    const guestTx = { ...txData, id: Date.now() };
                    State.transactions.unshift(guestTx);
                    localStorage.setItem('shouji_guest_data', JSON.stringify(State.transactions));
                    Helpers.showToast("已保存 (本地)");
                    Router.refresh();
                    return true;
                } else {
                    // [CLOUD] 云端模式：绝对不能传 ID (关键修复！)
                    // txData 里面没有 id 字段，这样数据库就会自动生成
                    const { error } = await supabaseClient.from('transactions').insert([txData]);
                    
                    if (!error) {
                        Helpers.showToast("已同步云端");
                        this.fetch();
                        return true;
                    } else {
                        alert("云端保存失败: " + error.message);
                        return false;
                    }
                }
            },

            async delete(id) {
                if(!confirm('确定删除这条记录吗？')) return;

                if (State.isGuest) {
                    State.transactions = State.transactions.filter(t => t.id !== id);
                    localStorage.setItem('shouji_guest_data', JSON.stringify(State.transactions));
                    Helpers.showToast("已删除");
                    Router.refresh();
                } else {
                    const { error } = await supabaseClient.from('transactions').delete().eq('id', id);
                    if(!error) {
                        Helpers.showToast("已删除");
                        this.fetch();
                    }
                }
            }
        };

        // --- 3. 路由与渲染 ---
        const Router = {
            currentTab: 'dashboard',
            navigate(tab) {
                this.currentTab = tab;
                document.querySelectorAll('.nav-item').forEach(el => {
                    el.classList.toggle('active', el.dataset.tab === tab);
                    el.classList.toggle('shadow-lg', el.dataset.tab === tab);
                    if(el.dataset.tab !== tab) {
                        el.classList.add('text-stone-500');
                        el.classList.remove('text-white');
                    }
                });

                const titles = { dashboard: '概览', analysis: '收支分析', transactions: '账单明细' };
                document.getElementById('page-title').innerText = titles[tab];
                document.getElementById('current-date').innerText = new Date().toLocaleDateString('zh-CN');

                this.render();
            },
            refresh() {
                this.render();
            },
            render() {
                const container = document.getElementById('main-view');
                if (this.currentTab === 'dashboard') Render.dashboard(container);
                if (this.currentTab === 'analysis') Render.analysis(container);
                if (this.currentTab === 'transactions') Render.transactions(container);
            }
        };

        const Render = {
            dashboard(container) {
                const stats = Helpers.calcStats();
                const recent = State.transactions.slice(0, 5);
                
                container.innerHTML = `
                    <div class="grid grid-cols-12 gap-6 animate-slide-in pb-10">
                        <div class="col-span-4 bg-white rounded-3xl p-6 shadow-card border border-stone-50 relative overflow-hidden group hover:-translate-y-1 transition">
                            <div class="absolute right-0 top-0 w-32 h-32 bg-teal-50 rounded-full blur-2xl -mr-10 -mt-10"></div>
                            <p class="text-sm text-stone-500 font-medium relative z-10">本月支出</p>
                            <h3 class="text-3xl font-bold text-stone-800 mt-2 relative z-10">¥${stats.exp}</h3>
                        </div>
                        <div class="col-span-4 bg-white rounded-3xl p-6 shadow-card border border-stone-50 relative overflow-hidden group hover:-translate-y-1 transition">
                             <div class="absolute right-0 top-0 w-32 h-32 bg-indigo-50 rounded-full blur-2xl -mr-10 -mt-10"></div>
                            <p class="text-sm text-stone-500 font-medium relative z-10">本月收入</p>
                            <h3 class="text-3xl font-bold text-stone-800 mt-2 relative z-10">¥${stats.inc}</h3>
                        </div>
                        <div class="col-span-4 bg-gradient-to-br from-teal-500 to-teal-700 rounded-3xl p-6 shadow-card text-white relative overflow-hidden group hover:-translate-y-1 transition">
                            <p class="text-sm text-teal-100 font-medium">净资产</p>
                            <h3 class="text-3xl font-bold mt-2">¥${stats.net}</h3>
                        </div>

                        <div class="col-span-4 bg-white rounded-3xl p-6 shadow-card border border-stone-50 h-[400px] flex flex-col">
                            <h3 class="font-bold text-stone-800 mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-pen-nib text-teal-500"></i> 快速记账
                            </h3>
                            <div class="flex bg-stone-100 p-1 rounded-xl mb-4">
                                <button onclick="Handlers.setType('expense')" id="btn-expense" class="flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow-sm text-stone-800">支出</button>
                                <button onclick="Handlers.setType('income')" id="btn-income" class="flex-1 py-2 rounded-lg text-sm font-bold text-stone-500">收入</button>
                            </div>
                            <div class="space-y-3 flex-1">
                                <div class="relative">
                                    <span class="absolute left-3 top-2.5 text-stone-400 font-bold">¥</span>
                                    <input type="number" id="in-amount" class="modern-input w-full pl-8 pr-4 py-2.5 rounded-xl font-bold text-stone-800" placeholder="0.00">
                                </div>
                                <select id="in-cat" class="modern-input w-full px-4 py-2.5 rounded-xl text-sm text-stone-700 appearance-none bg-white"></select>
                                <input type="text" id="in-note" class="modern-input w-full px-4 py-2.5 rounded-xl text-sm" placeholder="备注...">
                            </div>
                            <button onclick="Handlers.submit()" class="w-full bg-stone-800 hover:bg-black text-white py-3 rounded-xl font-bold mt-4 shadow-lg active:scale-95 transition">确认</button>
                        </div>

                        <div class="col-span-8 bg-white rounded-3xl p-6 shadow-card border border-stone-50 h-[400px] flex flex-col">
                            <h3 class="font-bold text-stone-800 mb-4">近期账单</h3>
                            <div class="flex-1 overflow-auto">
                                <table class="w-full text-left">
                                    <tbody class="text-sm">
                                        ${recent.map(t => {
                                            const cat = Helpers.getCat(t.type, t.category);
                                            return `
                                            <tr class="border-b border-stone-50 last:border-0 hover:bg-stone-50">
                                                <td class="py-3 pl-2">
                                                    <div class="flex items-center gap-3">
                                                        <div class="w-8 h-8 rounded-lg flex items-center justify-center text-xs" style="background:${cat.color}20; color:${cat.color}"><i class="fa-solid ${cat.icon}"></i></div>
                                                        <span class="font-medium text-stone-700">${cat.name}</span>
                                                    </div>
                                                </td>
                                                <td class="text-stone-400 text-xs">${t.note || '-'}</td>
                                                <td class="text-right font-bold pr-2 ${t.type==='expense'?'text-stone-800':'text-teal-600'}">
                                                    ${t.type==='expense'?'-':'+'} ${t.amount}
                                                </td>
                                            </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                                ${recent.length === 0 ? '<div class="text-center text-stone-300 mt-10">暂无数据</div>' : ''}
                            </div>
                        </div>
                    </div>
                `;
                Handlers.updateCatOptions();
            },

            analysis(container) {
                container.innerHTML = `
                    <div class="grid grid-cols-2 gap-6 pb-10 h-full">
                        <div class="col-span-1 bg-white rounded-3xl p-6 shadow-card flex flex-col items-center justify-center">
                            <h3 class="font-bold text-stone-800 mb-4 self-start border-l-4 border-teal-500 pl-2">支出构成</h3>
                            <div class="w-64 h-64"><canvas id="chart-pie"></canvas></div>
                        </div>
                        <div class="col-span-1 bg-white rounded-3xl p-6 shadow-card overflow-auto">
                            <h3 class="font-bold text-stone-800 mb-4 border-l-4 border-indigo-500 pl-2">分类排行</h3>
                            ${Helpers.getRank().map((item, i) => `
                                <div class="flex items-center gap-4 mb-3">
                                    <span class="text-stone-300 font-bold text-sm">0${i+1}</span>
                                    <div class="flex-1">
                                        <div class="flex justify-between text-sm mb-1"><span class="font-medium">${item.name}</span><span class="font-bold">¥${item.amount}</span></div>
                                        <div class="h-2 bg-stone-100 rounded-full overflow-hidden"><div class="h-full bg-teal-500" style="width:${item.pct}%"></div></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                setTimeout(() => {
                    const ctx = document.getElementById('chart-pie').getContext('2d');
                    const data = Helpers.getPieData();
                    new Chart(ctx, { type: 'doughnut', data: { labels: data.labels, datasets: [{ data: data.values, backgroundColor: data.colors, borderWidth: 0 }] }, options: { cutout: '70%', plugins: { legend: { position: 'bottom' } } } });
                }, 100);
            },

            transactions(container) {
                container.innerHTML = `
                    <div class="bg-white rounded-3xl shadow-card overflow-hidden">
                        <div class="p-6 border-b border-stone-100 flex justify-between"><h3 class="font-bold">全部记录</h3></div>
                        <div class="max-h-[70vh] overflow-auto">
                            <table class="w-full text-left">
                                <thead class="bg-stone-50 text-stone-500 text-xs uppercase font-medium"><tr><th class="px-6 py-4">分类</th><th class="px-6 py-4">时间</th><th class="px-6 py-4 text-right">金额</th><th class="px-6 py-4 text-center">操作</th></tr></thead>
                                <tbody class="divide-y divide-stone-50">
                                    ${State.transactions.map(t => {
                                        const cat = Helpers.getCat(t.type, t.category);
                                        return `
                                        <tr class="hover:bg-teal-50/20">
                                            <td class="px-6 py-4"><div class="flex items-center gap-3"><span class="font-medium text-stone-700">${cat.name}</span><span class="text-xs text-stone-400">${t.note||''}</span></div></td>
                                            <td class="px-6 py-4 text-xs text-stone-400">${new Date(t.date).toLocaleDateString()}</td>
                                            <td class="px-6 py-4 text-right font-bold ${t.type==='expense'?'text-stone-800':'text-teal-600'}">${t.type==='expense'?'-':'+'} ${t.amount}</td>
                                            <td class="px-6 py-4 text-center"><button onclick="DataService.delete(${t.id})" class="text-stone-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
            }
        };

        // --- 4. 辅助函数 ---
        const Handlers = {
            setType(t) {
                State.input.type = t;
                State.input.category = State.categories[t][0].id;
                document.getElementById('btn-expense').className = t==='expense' ? 'flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow-sm text-stone-800' : 'flex-1 py-2 rounded-lg text-sm font-bold text-stone-500';
                document.getElementById('btn-income').className = t==='income' ? 'flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow-sm text-teal-600' : 'flex-1 py-2 rounded-lg text-sm font-bold text-stone-500';
                this.updateCatOptions();
            },
            updateCatOptions() {
                const sel = document.getElementById('in-cat');
                if(sel) sel.innerHTML = State.categories[State.input.type].map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            },
            async submit() {
                const amt = document.getElementById('in-amount').value;
                const cat = document.getElementById('in-cat').value;
                const note = document.getElementById('in-note').value;
                if(!amt) return alert("请输入金额");
                
                const success = await DataService.add({
                    amount: parseFloat(amt),
                    type: State.input.type,
                    category: cat,
                    note: note,
                    date: new Date().toISOString()
                });

                if(success) {
                    document.getElementById('in-amount').value = '';
                    document.getElementById('in-note').value = '';
                }
            }
        };

        const Helpers = {
            getCat(type, id) { return State.categories[type].find(c => c.id === id) || { name: id, color: '#ccc', icon: 'fa-question' }; },
            showToast(msg) { const t = document.getElementById('toast-container'); document.getElementById('toast-msg').innerText = msg; t.classList.remove('opacity-0', 'translate-y-[-20px]'); setTimeout(() => t.classList.add('opacity-0', 'translate-y-[-20px]'), 2000); },
            calcStats() {
                const now = new Date(); const curMonth = now.toISOString().slice(0, 7);
                let exp=0, inc=0, net=0;
                State.transactions.forEach(t => {
                    if(t.type==='income') net += t.amount; else net -= t.amount;
                    if(t.date.startsWith(curMonth)) { if(t.type==='income') inc+=t.amount; else exp+=t.amount; }
                });
                return { exp: exp.toFixed(2), inc: inc.toFixed(2), net: net.toFixed(2) };
            },
            getPieData() {
                const map = {};
                State.transactions.filter(t=>t.type==='expense').forEach(t => { map[t.category] = (map[t.category]||0) + t.amount; });
                const labels=[], values=[], colors=[];
                Object.keys(map).forEach(k => { const c=this.getCat('expense',k); labels.push(c.name); values.push(map[k]); colors.push(c.color); });
                return { labels, values, colors };
            },
            getRank() {
                const map = {}; let total = 0;
                State.transactions.filter(t=>t.type==='expense').forEach(t => { map[t.category] = (map[t.category]||0) + t.amount; total+=t.amount; });
                return Object.keys(map).map(k => ({ name: this.getCat('expense', k).name, amount: map[k], pct: ((map[k]/total)*100).toFixed(0) })).sort((a,b)=>b.amount-a.amount).slice(0,5);
            }
        };

        window.addEventListener('DOMContentLoaded', () => {
            Auth.init();
        });
    </script>
</body>
</html>
